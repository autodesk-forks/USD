<!-- HTML header for doxygen 1.8.15-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.15"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Universal Scene Description: The TfMallocTag Memory Tagging System</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="usd_style.css" rel="stylesheet" type="text/css"/>
<link rel="shortcut icon" href="https://openusd.org/images/USDIcon.ico"/>
<!-- ... other metadata & script includes ... -->
<script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript">
    DoxygenAwesomeDarkModeToggle.init()
</script>
<script type="text/javascript" src="doxygen-awesome-fragment-copy-button.js"></script>
<script type="text/javascript">
    DoxygenAwesomeFragmentCopyButton.init()
</script>
<!-- Add warning banner to top of page if current page isn't the release version -->
<script>
function AddWarningBanner() 
{
  // Get current URL
  const loc = new URL(location.href);
  // Look for URL of the format "<USD hostname>/<version|dev|release>/api/<file.html>"
  // NOTE: If versioning approach ever changes, this will need updating
  var apiIndex = loc.pathname.indexOf("/api/");
  if (apiIndex >= 0) {
    // Truncate "/api/..." off path to get preceding path and "/" index
    var truncString = loc.pathname.slice(0,apiIndex);
    // Get index of first "/" before "/api/"
    var preApiIndex = truncString.lastIndexOf("/");
    var verString = truncString.slice(preApiIndex + 1);
    // if the current page isn't the release version, add a warning banner 
    if (verString !== "release") {
      // Create alternate "release" URL for page
      // NOTE: This won't always be a valid URL, e.g. if dev release has a brand new page
      var relURL = loc.pathname.substring(0,preApiIndex) + "/release" + loc.pathname.substring(apiIndex);
      var banner = document.createElement("div");
      banner.className = "non_release_version_warning";
      if (verString === "dev") {
        banner.innerHTML = "This document is for a version of USD that is under development. See <a href='" + relURL + "'>this page</a> for the current release.";
      } else {
        // For now, we assume any other string is an older version string
        banner.innerHTML = "This document is for an older version of USD. See <a href='" + relURL + "'>this page</a> for the current release.";
      }
      document.body.insertBefore(banner,document.body.childNodes[0]);
    }
  }
} 
</script>
</head>
<body onload="AddWarningBanner()">
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="USDLogoDocs.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.15 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('page_tf__malloc_tag.html','');});
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">The <a class="el" href="class_tf_malloc_tag.html" title="Top-down memory tagging system.">TfMallocTag</a> Memory Tagging System </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="MallocTagContents"></a>
Contents</h1>
<ul>
<li><a class="el" href="page_tf__malloc_tag.html#MallocTagOverview">Overview</a> </li>
<li><a class="el" href="page_tf__malloc_tag.html#MallocTagAddingTags">Adding Tags</a> </li>
<li><a class="el" href="page_tf__malloc_tag.html#MallocTagVaryingTags">Varying Tags</a> </li>
<li><a class="el" href="page_tf__malloc_tag.html#MallocTagPushPop">Manual Push / Pop</a> </li>
<li><a class="el" href="page_tf__malloc_tag.html#MallocTagPerformance">Performance Impact</a> </li>
<li><a class="el" href="page_tf__malloc_tag.html#MallocTagBestResults">Best Profiling Results</a> </li>
<li><a class="el" href="page_tf__malloc_tag.html#MallocTagMultithreading">Multithreading</a></li>
</ul>
<h1><a class="anchor" id="MallocTagOverview"></a>
Overview</h1>
<p>Accounting for memory use in a program is often difficult. The <a class="el" href="class_tf_malloc_tag.html" title="Top-down memory tagging system.">TfMallocTag</a> system is designed to track memory use in a hierarchical fashion. Memory use in this context refers specifically to allocations that you make using malloc() (and its variants) and free(). Note that this includes the C++ new and delete operators, since they (in general) simply call through to malloc() and free() (but see <a class="el" href="page_tf__malloc_tag.html#tf_MallocTag_BestResults">Best Profiling Results</a> as well).</p>
<p>The basic idea is that at any point during program execution, you can push a memory "tag" onto the local call stack. Allocations made while that tag is active are "billed" to that tag; at any point, you can query and see how much outstanding memory is due to that particular tag. If additional tags are pushed onto the stack, memory allocations are billed to these "children" tags but are also included in the bill to the parent tags.</p>
<p>Each line of code in the program that pushes a tag is called a <em>call-site</em>. A sequence of call-sites is called a <em>path</em> node and describes the hierarchy under which allocations take place. You use an object whose constructor pushes the tag and whose destructor pops the tag to control the lifetime of a tag. Consider the following example:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="malloc_tag_8h.html">pxr/base/tf/mallocTag.h</a>&quot;</span></div><div class="line"></div><div class="line"><span class="keywordtype">void</span> TopFunction() </div><div class="line">{</div><div class="line">    <a class="code" href="class_tf_malloc_tag_1_1_auto.html">TfAutoMallocTag</a> noname(<span class="stringliteral">&quot;Top&quot;</span>);      <span class="comment">// call-site &quot;Top&quot;</span></div><div class="line"></div><div class="line">    FuncA();</div><div class="line"></div><div class="line">    malloc(100);                        <span class="comment">// note1</span></div><div class="line"></div><div class="line">    FuncB();</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> FuncA() </div><div class="line">{</div><div class="line">    <a class="code" href="class_tf_malloc_tag_1_1_auto.html">TfAutoMallocTag</a> noname(<span class="stringliteral">&quot;A&quot;</span>);        <span class="comment">// call-site &quot;A&quot;</span></div><div class="line"></div><div class="line">    malloc(100);</div><div class="line"></div><div class="line">    FuncB();</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> FuncB() </div><div class="line">{</div><div class="line">    <a class="code" href="class_tf_malloc_tag_1_1_auto.html">TfAutoMallocTag</a> noname(<span class="stringliteral">&quot;B&quot;</span>);        <span class="comment">// call-site &quot;B&quot;</span></div><div class="line"></div><div class="line">    malloc(100);</div><div class="line">}</div></div><!-- fragment --><p>Suppose now that you invoke TopFunction(). The program has three different call-sites, Top, A and B. However, running TopFunction() generates the following distinct path nodes: Top, Top/A, Top/A/B, and Top/B.</p>
<p>The total memory billed to path node Top is 400. Calling TopFunction() results in allocations in itself, its direct calls FuncA() and FuncB(), and its indirect call to FuncB() from FuncA(). The direct memory billed to the path node Top is simply 100. That is the memory allocation noted by the line in the example marked <em>note1</em>. Even though this call comes after FuncA() has been called, the call-site tag A is no longer active, since it was popped off the stack when FuncA() exited.</p>
<p>Continuing the analysis, the total memory billed to Top/A is 200, the memory billed to Top/A/B is 100, and the memory billed to Top/B is also 100. To access these statistics, you call the GetCallTree() function on the <a class="el" href="class_tf_malloc_tag.html" title="Top-down memory tagging system.">TfMallocTag</a> object. Note that the system does not begin any actual accounting until Initialize() is called. Any memory allocations that occur prior to this point are "off the radar."</p>
<h1><a class="anchor" id="MallocTagAddingTags"></a>
Adding Tags</h1>
<p>The following example shows a typical use of tags in a library. Note that memory tags in a program need to be distinct from other people's tags, so you should follow the same basic guidelines that apply to avoiding name-conflicts in functions and classes.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="malloc_tag_8h.html">pxr/base/tf/mallocTag.h</a>&quot;</span></div><div class="line"></div><div class="line"><span class="keywordtype">void</span> FancyMesh::Assemble()</div><div class="line">{</div><div class="line">    <a class="code" href="class_tf_malloc_tag_1_1_auto.html">TfAutoMallocTag</a> noname(<span class="stringliteral">&quot;FancyMesh::Assemble&quot;</span>);</div><div class="line"></div><div class="line">    <span class="comment">// code that does a lot of allocation</span></div><div class="line">    <span class="comment">// code that calls CreateVertex(), CreateFace() a lot...</span></div><div class="line">    ...</div><div class="line">    ...</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> FancyMesh::CreateVertex()</div><div class="line">{</div><div class="line">    <a class="code" href="class_tf_malloc_tag_1_1_auto.html">TfAutoMallocTag</a> noname(<span class="stringliteral">&quot;FancyMesh::CreateVertex&quot;</span>);</div><div class="line">    ...</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> FancyMesh::CreateFace()</div><div class="line">{</div><div class="line">    <a class="code" href="class_tf_malloc_tag_1_1_auto.html">TfAutoMallocTag</a> noname(<span class="stringliteral">&quot;FancyMesh::CreateFace&quot;</span>);</div><div class="line">    ...</div><div class="line">}</div></div><!-- fragment --><h1><a class="anchor" id="MallocTagVaryingTags"></a>
Varying Tags</h1>
<p>Thus far, all of the tags shown in examples have been string literals. Sometimes it is useful to let tags be constructed on the fly, as in the following example:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> LoadModel(<span class="keywordtype">string</span> <span class="keyword">const</span>&amp; name)</div><div class="line">{</div><div class="line">    <a class="code" href="class_tf_malloc_tag_1_1_auto.html">TfAutoMallocTag</a> noname(<span class="stringliteral">&quot;LoadModel (&quot;</span> + name + <span class="stringliteral">&quot;)&quot;</span>);</div><div class="line">    ...</div><div class="line">}</div></div><!-- fragment --><p>This technique can generate any number of different call-sites (each distinct <code>name</code> passed in generates a different call-site) and thus a whole sequence of different path nodes.</p>
<p>Note that even if the tagging system is not being used (see Performance, below), the cost of building the call-site name string is still incurred in the above example. While this should almost never be a problem, extremely performance-intensive code should probably pass a string literal or previously constructed string, as opposed to creating a string (even an empty string).</p>
<h1><a class="anchor" id="MallocTagPushPop"></a>
Manual Push / Pop</h1>
<p>Occasionally, using local variables to delimit the scope of a tag isn't possible. You can make manual calls to Push() and Pop(), but whenever possible you should use TfAutoMallocTag.</p>
<h1><a class="anchor" id="MallocTagPerformance"></a>
Performance Impact</h1>
<p>The memory-cost for using the <a class="el" href="class_tf_malloc_tag.html" title="Top-down memory tagging system.">TfMallocTag</a> system is as follows:</p>
<ul>
<li>Each call to malloc() incurs no extra overhead compared with not using the tagging system. This is done by "stealing" some number of bits from a control-word that malloc() already tacks on to your memory requests. The implication of this is that users are restricted to malloc() requests that are no more than 1 terabyte (1&lt;&lt;40 bytes) at a time when the tagging system is activated. </li>
<li>The above applies to using the ptmalloc3 allocator. For jemalloc, every allocation is stored in a separate table, so there is an additional call to an allocator to add the entry, with possibly an extra memory allocation of its own. </li>
<li>Each different call-site and each different path-node reached during the program requires a small amount of memory to store its statistics, if tagging is on. Obviously, there is a one-time runtime cost to create each new call-site or path-node, but it is small, and is not repeated. </li>
<li>Pushing and popping call-site objects has effectively no cost if tagging is not active. </li>
<li>Pushing call-site objects requires locking a mutex and doing a single hash-lookup when tagging is active. Popping call-site objects does not incur a mutex lock. </li>
<li>Calls to malloc() and free() require an extra mutex lock when tagging is active.</li>
</ul>
<p>Obviously, a program that does nothing but allocate memory can be substantially impacted by turning tagging on. For typical applications, however, (such as Renderman, or loading models in Menv30) the actual runtime hit has proven (so far) to be in the 2-3 percent range when tagging is active. Programs with tags, but which have not called Initialize(), have no measurable increase in running times.</p>
<p>The above statement applies to ptmalloc3. For the jemalloc allocator, it's unclear right now what performance impact this might have for prman.</p>
<p><a class="anchor" id="tf_MallocTag_BestResults"></a></p>
<h1><a class="anchor" id="MallocTagBestResults"></a>
Best Profiling Results</h1>
<p>The memory statistics can be fooled by programs which contain their own allocators: in this case, the memory requested by the allocator itself does not correlate well with what tags are active. It is best to turn off as many internal allocators as possible.</p>
<p>In particular, the C++ STL library maintains its own allocator for small requests, as does the TF Library. The former can be turned off by setting the environment variable GLIBCXX_FORCE_NEW to any value. For simplicity, this will also deactivate the Tf Library allocator (see TfFixedSizeAllocator).</p>
<h1><a class="anchor" id="MallocTagMultithreading"></a>
Multithreading</h1>
<p>The <a class="el" href="class_tf_malloc_tag.html" title="Top-down memory tagging system.">TfMallocTag</a> system is completely thread-safe. Each thread has its own local stack of call-site objects. You can call <a class="el" href="class_tf_malloc_tag.html#ac05c3ae7dfa19d9034a1b5f4737548e8" title="Return a snapshot of memory usage.">TfMallocTag::GetCallTree()</a> or <a class="el" href="class_tf_malloc_tag.html#a94043f2dbe14589226a577f501eb384f" title="Return total number of allocated bytes.">TfMallocTag::GetTotalBytes()</a> at any time and from any thread. </p>
</div></div><!-- PageDoc -->
</div><!-- contents -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.9.6-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="tf_page_front.html">Tf: Tools Foundations</a></li>
    <li class="footer">&copy; Copyright 2023, Pixar Animation Studios. Generated on Mon Nov 20 2023 16:06:57 by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.8.15 </li>
  </ul>
</div>
</body>
</html>