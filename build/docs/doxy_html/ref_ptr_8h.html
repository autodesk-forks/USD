<!-- HTML header for doxygen 1.8.15-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.15"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Universal Scene Description: pxr/base/tf/refPtr.h File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="usd_style.css" rel="stylesheet" type="text/css"/>
<link rel="shortcut icon" href="https://openusd.org/images/USDIcon.ico"/>
<!-- ... other metadata & script includes ... -->
<script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript">
    DoxygenAwesomeDarkModeToggle.init()
</script>
<script type="text/javascript" src="doxygen-awesome-fragment-copy-button.js"></script>
<script type="text/javascript">
    DoxygenAwesomeFragmentCopyButton.init()
</script>
<!-- Add warning banner to top of page if current page isn't the release version -->
<script>
function AddWarningBanner() 
{
  // Get current URL
  const loc = new URL(location.href);
  // Look for URL of the format "<USD hostname>/<version|dev|release>/api/<file.html>"
  // NOTE: If versioning approach ever changes, this will need updating
  var apiIndex = loc.pathname.indexOf("/api/");
  if (apiIndex >= 0) {
    // Truncate "/api/..." off path to get preceding path and "/" index
    var truncString = loc.pathname.slice(0,apiIndex);
    // Get index of first "/" before "/api/"
    var preApiIndex = truncString.lastIndexOf("/");
    var verString = truncString.slice(preApiIndex + 1);
    // if the current page isn't the release version, add a warning banner 
    if (verString !== "release") {
      // Create alternate "release" URL for page
      // NOTE: This won't always be a valid URL, e.g. if dev release has a brand new page
      var relURL = loc.pathname.substring(0,preApiIndex) + "/release" + loc.pathname.substring(apiIndex);
      var banner = document.createElement("div");
      banner.className = "non_release_version_warning";
      if (verString === "dev") {
        banner.innerHTML = "This document is for a version of USD that is under development. See <a href='" + relURL + "'>this page</a> for the current release.";
      } else {
        // For now, we assume any other string is an older version string
        banner.innerHTML = "This document is for an older version of USD. See <a href='" + relURL + "'>this page</a> for the current release.";
      }
      document.body.insertBefore(banner,document.body.childNodes[0]);
    }
  }
} 
</script>
</head>
<body onload="AddWarningBanner()">
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="USDLogoDocs.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.15 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('ref_ptr_8h.html','');});
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#nested-classes">Classes</a> &#124;
<a href="#define-members">Macros</a>  </div>
  <div class="headertitle">
<div class="title">refPtr.h File Reference<div class="ingroups"><a class="el" href="group__group__tf___memory.html">Memory Management</a></div></div>  </div>
</div><!--header-->
<div class="contents">

<p>Reference counting.  
<a href="#details">More...</a></p>
<div class="textblock"><div id="dynsection-0" onclick="return toggleVisibility(this)" class="dynheader closed" style="cursor:pointer;">
  <img id="dynsection-0-trigger" src="closed.png" alt="+"/> Include dependency graph for refPtr.h:</div>
<div id="dynsection-0-summary" class="dynsummary" style="display:block;">
</div>
<div id="dynsection-0-content" class="dyncontent" style="display:none;">
<div class="center"><img src="ref_ptr_8h__incl.png" border="0" usemap="#pxr_2base_2tf_2ref_ptr_8h" alt=""/></div>
<map name="pxr_2base_2tf_2ref_ptr_8h" id="pxr_2base_2tf_2ref_ptr_8h">
<area shape="rect"  title="Reference counting." alt="" coords="1750,5,1892,32"/>
<area shape="rect"  href="pxr_8h.html" title=" " alt="" coords="1147,379,1225,405"/>
<area shape="rect"  href="diagnostic_lite_8h.html" title="Stripped down version of diagnostic.h that doesn&#39;t define std::string." alt="" coords="411,80,609,107"/>
<area shape="rect"  href="tf_2hash_8h.html" title=" " alt="" coords="1672,80,1811,107"/>
<area shape="rect"  href="null_ptr_8h_source.html" title=" " alt="" coords="776,155,925,181"/>
<area shape="rect"  href="ref_base_8h.html" title=" " alt="" coords="1051,80,1209,107"/>
<area shape="rect"  href="safe_type_compare_8h.html" title="Safely compare C++ RTTI type structures." alt="" coords="2342,80,2567,107"/>
<area shape="rect"  href="type_functions_8h.html" title=" " alt="" coords="2067,80,2265,107"/>
<area shape="rect"  href="base_2tf_2api_8h_source.html" title=" " alt="" coords="779,229,907,256"/>
<area shape="rect"  href="hints_8h.html" title="Compiler hints." alt="" coords="5,155,163,181"/>
<area shape="rect"  title=" " alt="" coords="2505,155,2580,181"/>
<area shape="rect"  title=" " alt="" coords="2047,155,2139,181"/>
<area shape="rect"  title=" " alt="" coords="2643,80,2713,107"/>
<area shape="rect"  href="attributes_8h.html" title="Define function attributes." alt="" coords="497,229,687,256"/>
<area shape="rect"  href="build_mode_8h_source.html" title=" " alt="" coords="741,304,933,331"/>
<area shape="rect"  href="call_context_8h.html" title="Functions for recording call locations." alt="" coords="239,155,421,181"/>
<area shape="rect"  title=" " alt="" coords="121,229,196,256"/>
<area shape="rect"  href="export_8h.html" title="Defines symbol visibility macros." alt="" coords="548,304,716,331"/>
<area shape="rect"  href="defines_8h_source.html" title=" " alt="" coords="648,379,821,405"/>
<area shape="rect"  href="function_lite_8h.html" title="Define preprocessor function name macros." alt="" coords="220,304,423,331"/>
<area shape="rect"  href="tf_8h.html" title="A file containing basic constants and definitions." alt="" coords="1341,155,1459,181"/>
<area shape="rect"  title=" " alt="" coords="1621,155,1688,181"/>
<area shape="rect"  title=" " alt="" coords="1712,155,1771,181"/>
<area shape="rect"  title=" " alt="" coords="1795,155,1845,181"/>
<area shape="rect"  title=" " alt="" coords="2164,155,2241,181"/>
<area shape="rect"  title=" " alt="" coords="1869,155,1912,181"/>
<area shape="rect"  title=" " alt="" coords="1937,155,2023,181"/>
<area shape="rect"  title=" " alt="" coords="1243,229,1303,256"/>
<area shape="rect"  title=" " alt="" coords="1534,155,1596,181"/>
<area shape="rect"  href="arch_2math_8h.html" title="Architecture&#45;specific math function calls." alt="" coords="1572,229,1732,256"/>
<area shape="rect"  href="inttypes_8h.html" title="Define integral types." alt="" coords="1415,304,1593,331"/>
<area shape="rect"  title=" " alt="" coords="1327,229,1395,256"/>
<area shape="rect"  title=" " alt="" coords="1618,304,1680,331"/>
<area shape="rect"  title=" " alt="" coords="1364,379,1447,405"/>
<area shape="rect"  title=" " alt="" coords="1471,379,1537,405"/>
<area shape="rect"  title=" " alt="" coords="1561,379,1657,405"/>
<area shape="rect"  href="ref_count_8h.html" title=" " alt="" coords="1102,155,1265,181"/>
<area shape="rect"  title=" " alt="" coords="1152,229,1219,256"/>
</map>
</div>
</div><div class="textblock"><div id="dynsection-1" onclick="return toggleVisibility(this)" class="dynheader closed" style="cursor:pointer;">
  <img id="dynsection-1-trigger" src="closed.png" alt="+"/> This graph shows which files directly or indirectly include this file:</div>
<div id="dynsection-1-summary" class="dynsummary" style="display:block;">
</div>
<div id="dynsection-1-content" class="dyncontent" style="display:none;">
<div class="center"><img src="ref_ptr_8h__dep__incl.png" border="0" usemap="#pxr_2base_2tf_2ref_ptr_8hdep" alt=""/></div>
<map name="pxr_2base_2tf_2ref_ptr_8hdep" id="pxr_2base_2tf_2ref_ptr_8hdep">
<area shape="rect"  title="Reference counting." alt="" coords="5154,5,5296,32"/>
<area shape="rect"  href="base_2plug_2registry_8h_source.html" title=" " alt="" coords="4353,387,4527,413"/>
<area shape="rect"  href="declare_ptrs_8h.html" title="Standard pointer typedefs." alt="" coords="2512,304,2693,331"/>
<area shape="rect"  href="instantiate_type_8h_source.html" title=" " alt="" coords="3995,80,4203,107"/>
<area shape="rect"  href="make_py_constructor_8h.html" title="An injected constructor mechanism that works with polymorphic wrapped classes." alt="" coords="5863,477,6097,504"/>
<area shape="rect"  href="py_container_conversions_8h.html" title="Utilities for providing C++ &lt;&#45;&gt; Python container support." alt="" coords="5645,387,5912,413"/>
<area shape="rect"  href="py_identity_8h_source.html" title=" " alt="" coords="5987,387,6159,413"/>
<area shape="rect"  href="py_polymorphic_8h.html" title=" " alt="" coords="5293,304,5499,331"/>
<area shape="rect"  href="py_ptr_helpers_8h.html" title="Enables wrapping of Weak or Ref &amp; Weak held types to python." alt="" coords="6152,477,6344,504"/>
<area shape="rect"  href="base_2tf_2py_utils_8h.html" title="Miscellaneous Utilities for dealing with script." alt="" coords="5725,304,5880,331"/>
<area shape="rect"  href="weak_base_8h.html" title=" " alt="" coords="4227,80,4401,107"/>
<area shape="rect"  href="weak_ptr_8h.html" title="Pointer storage with deletion detection." alt="" coords="5049,229,5209,256"/>
<area shape="rect"  href="weak_ptr_facade_8h_source.html" title=" " alt="" coords="4606,155,4812,181"/>
<area shape="rect"  href="aggregate_node_8h_source.html" title=" " alt="" coords="46,379,231,421"/>
<area shape="rect"  href="collector_8h_source.html" title=" " alt="" coords="4829,387,5016,413"/>
<area shape="rect"  href="event_node_8h_source.html" title=" " alt="" coords="4552,387,4755,413"/>
<area shape="rect"  href="event_tree_8h_source.html" title=" " alt="" coords="4840,477,5035,504"/>
<area shape="rect"  href="simple_shadow_array_8h.html" title=" " alt="" coords="5299,379,5519,421"/>
<area shape="rect"  href="glf_2texture_8h.html" title=" " alt="" coords="5091,387,5275,413"/>
<area shape="rect"  href="this_plugin_8h_source.html" title=" " alt="" coords="4377,477,4567,504"/>
<area shape="rect"  href="plugin_registry_8h_source.html" title=" " alt="" coords="4592,477,4816,504"/>
<area shape="rect"  href="base_2plug_2notice_8h_source.html" title=" " alt="" coords="3622,387,3788,413"/>
<area shape="rect"  href="plugin_8h_source.html" title=" " alt="" coords="494,387,660,413"/>
<area shape="rect"  href="reporter_8h_source.html" title=" " alt="" coords="954,477,1136,504"/>
<area shape="rect"  href="reporter_base_8h_source.html" title=" " alt="" coords="838,387,1052,413"/>
<area shape="rect"  href="reporter_data_source_collector_8h_source.html" title=" " alt="" coords="1795,379,1997,421"/>
<area shape="rect"  href="ndr_2discovery_plugin_8h_source.html" title=" " alt="" coords="255,387,469,413"/>
<area shape="rect"  href="pcp_2cache_8h_source.html" title=" " alt="" coords="3007,560,3157,587"/>
<area shape="rect"  href="changes_8h.html" title=" " alt="" coords="2285,477,2451,504"/>
<area shape="rect"  href="dependency_8h_source.html" title=" " alt="" coords="2987,387,3177,413"/>
<area shape="rect"  href="dynamic_file_format_dependency_data_8h_source.html" title=" " alt="" coords="2022,379,2247,421"/>
<area shape="rect"  href="expression_variables_dependency_data_8h_source.html" title=" " alt="" coords="2272,379,2504,421"/>
<area shape="rect"  href="layer_stack_8h.html" title=" " alt="" coords="3254,387,3436,413"/>
<area shape="rect"  href="prim_index_8h_source.html" title=" " alt="" coords="2659,477,2837,504"/>
<area shape="rect"  href="pcp_2site_8h_source.html" title=" " alt="" coords="3461,387,3597,413"/>
<area shape="rect"  href="abstract_data_8h_source.html" title=" " alt="" coords="1373,387,1568,413"/>
<area shape="rect"  href="data_8h_source.html" title=" " alt="" coords="1680,477,1819,504"/>
<area shape="rect"  href="declare_handles_8h.html" title=" " alt="" coords="3813,387,4024,413"/>
<area shape="rect"  href="file_format_8h.html" title=" " alt="" coords="3865,477,4041,504"/>
<area shape="rect"  href="layer_8h.html" title=" " alt="" coords="1785,560,1927,587"/>
<area shape="rect"  href="layer_state_delegate_8h_source.html" title=" " alt="" coords="4117,477,4352,504"/>
<area shape="rect"  href="prim_spec_8h.html" title=" " alt="" coords="2579,387,2749,413"/>
<area shape="rect"  href="property_spec_8h.html" title=" " alt="" coords="3290,477,3485,504"/>
<area shape="rect"  href="collection_membership_query_8h.html" title=" " alt="" coords="1213,470,1456,511"/>
<area shape="rect"  href="common_8h.html" title=" " alt="" coords="1128,387,1299,413"/>
<area shape="rect"  href="edit_context_8h_source.html" title=" " alt="" coords="2773,387,2963,413"/>
<area shape="rect"  href="prim_8h.html" title=" " alt="" coords="787,477,929,504"/>
<area shape="rect"  href="prim_data_8h.html" title=" " alt="" coords="1481,477,1655,504"/>
<area shape="rect"  href="resolve_info_8h.html" title=" " alt="" coords="713,709,900,736"/>
<area shape="rect"  href="stage_8h.html" title=" " alt="" coords="892,635,1041,661"/>
</map>
</div>
</div>
<p><a href="ref_ptr_8h_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="nested-classes"></a>
Classes</h2></td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">class &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_tf_weak_ptr.html">TfWeakPtr&lt; T &gt;</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight">Pointer storage with deletion detection.  <a href="class_tf_weak_ptr.html#details">More...</a><br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">class &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_tf_ref_ptr.html">TfRefPtr&lt; T &gt;</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight">Reference-counted smart pointer utility class.  <a href="class_tf_ref_ptr.html#details">More...</a><br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="define-members"></a>
Macros</h2></td></tr>
<tr class="memitem:a3e20c45d7ac01819aeabe2e4fc74d462"><td class="memItemLeft" align="right" valign="top"><a id="a3e20c45d7ac01819aeabe2e4fc74d462"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><b>TF_SUPPORTS_REFPTR</b>(T)&#160;&#160;&#160;std::is_base_of&lt;<a class="el" href="class_tf_ref_base.html">TfRefBase</a>, T&gt;::value</td></tr>
<tr class="separator:a3e20c45d7ac01819aeabe2e4fc74d462"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Reference counting. </p>
<p><a class="anchor" id="refPtr_QuickStart"></a><b> Quick Start </b></p>
<p>Here is how to make a class <code>Bunny</code> usable through <code><a class="el" href="class_tf_ref_ptr.html" title="Reference-counted smart pointer utility class.">TfRefPtr</a></code>.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="ref_ptr_8h.html">pxr/base/tf/refPtr.h</a>&quot;</span></div><div class="line"><span class="keyword">typedef</span> <a class="code" href="class_tf_ref_ptr.html">TfRefPtr&lt;Bunny&gt;</a> BunnyRefPtr;</div><div class="line"></div><div class="line"><span class="keyword">class </span>Bunny : <span class="keyword">public</span> <a class="code" href="class_tf_ref_base.html">TfRefBase</a> {</div><div class="line"><span class="keyword">public</span>:</div><div class="line">    <span class="keyword">static</span> BunnyRefPtr New() {</div><div class="line">       <span class="comment">// warning: return new Bunny directly will leak memory!</span></div><div class="line">       <span class="keywordflow">return</span> TfCreateRefPtr(<span class="keyword">new</span> Bunny);</div><div class="line">    }</div><div class="line">    <span class="keyword">static</span> BunnyRefPtr New(<span class="keywordtype">bool</span> isRabid) {</div><div class="line">       <span class="keywordflow">return</span> TfCreateRefPtr(<span class="keyword">new</span> Bunny(isRabid));</div><div class="line">    }</div><div class="line"></div><div class="line">    ~Bunny();</div><div class="line"></div><div class="line">    <span class="keywordtype">bool</span> IsHungry();</div><div class="line"> <span class="keyword">private</span>:</div><div class="line">    Bunny();</div><div class="line">    Bunny(<span class="keywordtype">bool</span>);</div><div class="line">};</div><div class="line"></div><div class="line">BunnyRefPtr nice = Bunny::New();</div><div class="line">BunnyRefPtr mean = Bunny::New(<span class="keyword">true</span>);    <span class="comment">// this one is rabid</span></div><div class="line"></div><div class="line">BunnyRefPtr mean2 = mean;               <span class="comment">// two references to mean rabbit</span></div><div class="line">mean.Reset();                        <span class="comment">// one reference to mean rabbit</span></div><div class="line"></div><div class="line"><span class="keywordflow">if</span> (mean2-&gt;IsHungry())</div><div class="line">     nice.Reset();                   <span class="comment">// nice bunny gone now...</span></div><div class="line"></div><div class="line">                                     <span class="comment">// this function comes from</span></div><div class="line">                                     <span class="comment">// TfRefBase; meaning is that</span></div><div class="line"><span class="keywordflow">if</span> (mean2-&gt;IsUnique())               <span class="comment">// mean2 is the last pointer to</span></div><div class="line">    mean2.Reset();                   <span class="comment">// this bunny...</span></div></div><!-- fragment --><p>Pretty much any pointer operation that is legal with regular pointers is legal with the <code>BunnyRefPtr</code>; continue reading for a more detailed description.</p>
<p>Note that by virtue of deriving from <code><a class="el" href="class_tf_ref_base.html" title="Enable a concrete base class for use with TfRefPtr.">TfRefBase</a></code>, the reference count can be queried: see <code><a class="el" href="class_tf_ref_base.html" title="Enable a concrete base class for use with TfRefPtr.">TfRefBase</a></code> for details.</p>
<p><a class="anchor" id="refPtr_DetailedDiscussion"></a><b> Detailed Discussion: Overview </b></p>
<p>Objects created by the <code>new</code> operator can easily be a source of both memory leaks and dangling pointers. One solution is <em>reference</em> counting; when an object is created by <code>new</code>, the number of pointers given the object's address is continually tracked in a <em>reference</em> <em>counter</em>. Then, <code>delete</code> is called on the object <em>only</em> when the object's reference count drops to zero, meaning there are no more pointers left pointing to the object. Reference counting avoids both dangling pointers and memory leaks.</p>
<p>Access by regular pointers does not perform reference counting, but the <code>TfRefPtr&lt;T&gt;</code> class implements reference-counted pointer access to objects of type <code>T</code>, with minimal overhead. The reference counting is made thread-safe by use of atomic integers.</p>
<p><b> Basic Use </b></p>
<p>The use of a <code><a class="el" href="class_tf_ref_ptr.html" title="Reference-counted smart pointer utility class.">TfRefPtr</a></code> is simple. Whenever a <code><a class="el" href="class_tf_ref_ptr.html" title="Reference-counted smart pointer utility class.">TfRefPtr</a></code> is made to point at an object, either by initialization or assignment, the object being pointed at has its reference count incremented. When a <code><a class="el" href="class_tf_ref_ptr.html" title="Reference-counted smart pointer utility class.">TfRefPtr</a></code> with a non-NULL address is reassigned, or goes out of scope, the object being pointed to has its reference count decremented.</p>
<p>A <code>TfRefPtr&lt;T&gt;</code> can access <code>T's</code> public members by the <code>-&gt;</code> operator and can be dereferenced by the "\c *" operator. Here is a simple example: </p><div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="ref_ptr_8h.html">pxr/base/tf/refPtr.h</a>&quot;</span></div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <a class="code" href="class_tf_ref_ptr.html">TfRefPtr&lt;Simple&gt;</a> SimpleRefPtr;</div><div class="line"></div><div class="line"><span class="keyword">class </span>Simple : <span class="keyword">public</span> <a class="code" href="class_tf_ref_base.html">TfRefBase</a> {</div><div class="line"><span class="keyword">public</span>:</div><div class="line">    <span class="keywordtype">void</span> Method1();</div><div class="line">    <span class="keywordtype">int</span>  Method2();</div><div class="line"></div><div class="line">    <span class="keyword">static</span> SimpleRefPtr New() {</div><div class="line">        <span class="keywordflow">return</span> TfCreateRefPtr(<span class="keyword">new</span> Simple);</div><div class="line">    }</div><div class="line">  <span class="keyword">private</span>:</div><div class="line">    Simple();</div><div class="line">};</div><div class="line"></div><div class="line"></div><div class="line">SimpleRefPtr p1;                         <span class="comment">// p1 points to NULL</span></div><div class="line">SimpleRefPtr p2 = Simple::New();         <span class="comment">// p2 points to new object A</span></div><div class="line">SimpleRefPtr p3 = Simple::New();         <span class="comment">// p3 points to new object B</span></div><div class="line"></div><div class="line">p1-&gt;Method1();                        <span class="comment">// runtime error -- p1 is NULL</span></div><div class="line">p3 = p2;                              <span class="comment">// object B is deleted</span></div><div class="line">p2-&gt;Method1();                        <span class="comment">// Method1 on object A</span></div><div class="line"><span class="keywordtype">int</span> value = p3-&gt;Method2();            <span class="comment">// Method2 on object A</span></div><div class="line"></div><div class="line">p2.Reset();                           <span class="comment">// only p3 still points at A</span></div><div class="line">p3 = p1;                              <span class="comment">// object A is deleted</span></div><div class="line"></div><div class="line"><span class="keywordflow">if</span> (...) {</div><div class="line">    SimpleRefPtr p4 = Simple::New();     <span class="comment">// p4 points to object C</span></div><div class="line">    p4-&gt;Method1();</div><div class="line">}                                     <span class="comment">// object C destroyed</span></div></div><!-- fragment --><p>Note that <code>Simple's</code> constructor is private; this ensures that one can only get at a <code>Simple</code> through <code>Simple::New()</code>, which is careful to return a <code>SimpleRefPtr</code>.</p>
<p>Note that it is often useful to have both const and non-const versions of <code><a class="el" href="class_tf_ref_ptr.html" title="Reference-counted smart pointer utility class.">TfRefPtr</a></code> for the same data type. Our convention is to use a <code>typedef</code> for each of these, with the const version beginning with "Const", after any prefix. The const version can be used as a parameter to a function in which you want to prevent changes to the pointed-to object. For example: </p><div class="fragment"><div class="line"><span class="keyword">typedef</span> <a class="code" href="class_tf_ref_ptr.html">TfRefPtr&lt;XySimple&gt;</a>       XySimpleRefPtr;</div><div class="line"><span class="keyword">typedef</span> <a class="code" href="class_tf_ref_ptr.html">TfRefPtr&lt;const XySimple&gt;</a> XyConstSimpleRefPtr;</div><div class="line"></div><div class="line"><span class="keywordtype">void</span></div><div class="line">Func1(<span class="keyword">const</span> XySimpleRefPtr &amp;p)</div><div class="line">{</div><div class="line">    p-&gt;Modify();  <span class="comment">// OK even if Modify() is not a const member</span></div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span></div><div class="line">Func2(<span class="keyword">const</span> XyConstSimpleRefPtr &amp;p)</div><div class="line">{</div><div class="line">    p-&gt;Query();   <span class="comment">// OK only if Query() is a const member</span></div><div class="line">}</div></div><!-- fragment --><p>It is always possible to assign a non-const pointer to a const pointer variable. In extremely rare cases where you want to do the opposite, you can use the <code>TfConst_cast</code> function, as in: </p><div class="fragment"><div class="line">XyConstSimpleRefPtr p1;</div><div class="line">XySimpleRefPtr      p2;</div><div class="line"></div><div class="line">p1 = p2;                            <span class="comment">// OK</span></div><div class="line">p2 = p1;                            <span class="comment">// Illegal!</span></div><div class="line">p2 = TfConst_cast&lt;XySimpleRefPtr&gt;(p1); <span class="comment">// OK, but discouraged</span></div></div><!-- fragment --><p><b> Comparisons and Tests </b></p>
<p>Reference-counted pointers of like type can be compared; any <code><a class="el" href="class_tf_ref_ptr.html" title="Reference-counted smart pointer utility class.">TfRefPtr</a></code> can be tested to see it is NULL or not:</p>
<div class="fragment"><div class="line"><a class="code" href="class_tf_ref_ptr.html">TfRefPtr&lt;Elf&gt;</a>   elf = Elf::New();</div><div class="line"><a class="code" href="class_tf_ref_ptr.html">TfRefPtr&lt;Dwarf&gt;</a> sleepy,</div><div class="line">                sneezy = Dwarf::New();</div><div class="line"></div><div class="line"><span class="keywordflow">if</span> (!sleepy)</div><div class="line">    ...                          <span class="comment">// true: sleepy is NULL</span></div><div class="line"></div><div class="line"><span class="keywordflow">if</span> (sneezy)</div><div class="line">    ...                          <span class="comment">// true: sneezy is non-nULL</span></div><div class="line"></div><div class="line"><span class="keywordtype">bool</span> b1 = (sleepy != sneezy),</div><div class="line">     b2 = (sleepy == sneezy),</div><div class="line">     b3 = (elf == sneezy);       <span class="comment">// compilation error -- type clash</span></div></div><!-- fragment --><p><b> Opaqueness </b></p>
<p>A <code><a class="el" href="class_tf_ref_ptr.html" title="Reference-counted smart pointer utility class.">TfRefPtr</a></code> can be used as an opaque pointer, just as a regular pointer can. For example, without having included the header file for a class <code>XySimple</code>, the following will still compile: </p><div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="ref_ptr_8h.html">pxr/base/tf/refPtr.h</a>&quot;</span></div><div class="line"></div><div class="line"><span class="keyword">class </span>XySimple;</div><div class="line"></div><div class="line"><span class="keyword">class </span>Complicated {</div><div class="line"> <span class="keyword">public</span>:</div><div class="line">    <span class="keywordtype">void</span> SetSimple(<span class="keyword">const</span> <a class="code" href="class_tf_ref_ptr.html">TfRefPtr&lt;XySimple&gt;</a>&amp; s) {</div><div class="line">        _simplePtr = s;</div><div class="line">    }</div><div class="line"></div><div class="line">    <a class="code" href="class_tf_ref_ptr.html">TfRefPtr&lt;XySimple&gt;</a> GetSimple() {</div><div class="line">        <span class="keywordflow">return</span> _simplePtr;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordtype">void</span> Forget() {</div><div class="line">         _simplePtr.<a class="code" href="class_tf_ref_ptr.html#a372de693ad40b3f42839c8ec6ac845f4">Reset</a>();</div><div class="line">    }</div><div class="line"></div><div class="line"> <span class="keyword">private</span>:</div><div class="line">    <a class="code" href="class_tf_ref_ptr.html">TfRefPtr&lt;XySimple&gt;</a> _simplePtr;</div><div class="line">};</div></div><!-- fragment --><p>Note that the call <code>Forget()</code> (or <code>SetSimple()</code> for that matter) may implicitly cause destruction of an <code>XySimple</code> object, if the count of the object pointed to by <code>_simplePtr</code> drops to zero. Even though the definition of <code>XySimple</code> is unknown, this compiles and works correctly.</p>
<p>The only time that the definition of <code>XySimple</code> is required is when putting a raw <code>XySimple*</code> into a <code>TfRefPtr&lt;XySimple&gt;</code>; note however, that this should in fact only be done within the class definition of <code>XySimple</code> itself.</p>
<p>Other cases that require a definition of <code>XySimple</code> are parallel to regular raw pointers, such as calling a member function, static or dynamic casts (but not const casts) and using the <code>TfTypeid</code> function. Transferring a <code><a class="el" href="class_tf_weak_ptr.html" title="Pointer storage with deletion detection.">TfWeakPtr</a></code> to a <code><a class="el" href="class_tf_ref_ptr.html" title="Reference-counted smart pointer utility class.">TfRefPtr</a></code> also requires knowing the definition of <code>XySimple</code>.</p>
<p>Sometimes a class may have many typedefs associated with it, having to do with <code><a class="el" href="class_tf_ref_ptr.html" title="Reference-counted smart pointer utility class.">TfRefPtr</a></code> or <code><a class="el" href="class_tf_weak_ptr.html" title="Pointer storage with deletion detection.">TfWeakPtr</a></code>. If it is useful to use the class opaquely, we recommend creating a separate file as follows:</p>
<div class="fragment"><div class="line"><span class="comment">// file: proj/xy/simplePtrDefs.h</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="ref_ptr_8h.html">pxr/base/tf/refPtr.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="weak_ptr_8h.html">pxr/base/tf/weakPtr.h</a>&quot;</span></div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <a class="code" href="class_tf_ref_ptr.html">TfRefPtr&lt;class XySimple&gt;</a>       XySimpleRefPtr;</div><div class="line"><span class="keyword">typedef</span> <a class="code" href="class_tf_ref_ptr.html">TfRefPtr&lt;const class XySimple&gt;</a> XyConstSimpleRefPtr;</div><div class="line"></div><div class="line"><span class="comment">// typedefs for TfWeakPtr&lt;XySimple&gt; would follow,</span></div><div class="line"><span class="comment">// if XySimple derives from TfWeakBase</span></div></div><!-- fragment --><p>The definition for <code>XySimple</code> would then use the typedefs:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;Proj/Xy/SimpleRefPtrDefs.h&quot;</span></div><div class="line"></div><div class="line"><span class="keyword">class </span>XySimple : <span class="keyword">public</span> <a class="code" href="class_tf_ref_base.html">TfRefBase</a> {</div><div class="line"><span class="keyword">public</span>:</div><div class="line">    <span class="keyword">static</span> XySimpleRefPtr New();</div><div class="line">    ...</div><div class="line">};</div></div><!-- fragment --><p>The above pattern now allows a consumer of class <code>XySimple</code> the option to include only <code>simplePtrDefs.h</code>, if using the type opaquely suffices, or to include <code>simple.h</code>, if the class definition is required.</p>
<p><b> Cyclic Dependencies </b></p>
<p>If you build a tree using <code><a class="el" href="class_tf_ref_ptr.html" title="Reference-counted smart pointer utility class.">TfRefPtr</a></code>, and you only have pointers from parent to child, everything is fine: if you "lose" the root of the tree, the tree will correctly destroy itself.</p>
<p>But what if children point back to parents? Then a simple parent/child pair is stable, because the parent and child point at each other, and even if nobody else has a pointer to the parent, the reference count of the two nodes remains at one.</p>
<p>The solution to this is to make one of the links (typically from child back to parent) use a <code><a class="el" href="class_tf_weak_ptr.html" title="Pointer storage with deletion detection.">TfWeakPtr</a></code>. If a class <code>T</code> is enabled for both "guarding" (see <code><a class="el" href="class_tf_weak_base.html" title="Enable a concrete base class for use with TfWeakPtr.">TfWeakBase</a></code>) and reference counting, then a <code><a class="el" href="class_tf_ref_ptr.html" title="Reference-counted smart pointer utility class.">TfRefPtr</a></code> can be converted to a <code><a class="el" href="class_tf_weak_ptr.html" title="Pointer storage with deletion detection.">TfWeakPtr</a></code> (in this context, a "back pointer") and vice versa.</p>
<p><b> Inheritance </b></p>
<p>Reference-counted pointers obey the same rules with respect to inheritance as regular pointers. In particular, if class <code>Derived</code> is derived from class <code>Base</code>, then the following are legal:</p>
<div class="fragment"><div class="line"><a class="code" href="class_tf_ref_ptr.html">TfRefPtr&lt;Base&gt;</a>    bPtr = <span class="keyword">new</span> Base;</div><div class="line"><a class="code" href="class_tf_ref_ptr.html">TfRefPtr&lt;Derived&gt;</a> dPtr = <span class="keyword">new</span> Derived;</div><div class="line"></div><div class="line"><a class="code" href="class_tf_ref_ptr.html">TfRefPtr&lt;Base&gt;</a> b2Ptr = dPtr;      <span class="comment">// initialization</span></div><div class="line">b2Ptr = dPtr;                        <span class="comment">// assignment</span></div><div class="line">b2Ptr == dPtr;                       <span class="comment">// comparison</span></div><div class="line"></div><div class="line">dPtr = bPtr;                         <span class="comment">// Not legal: compilation error</span></div></div><!-- fragment --><p>As the last example shows, initialization or assignment to a <code>TfRefPtr&lt;Derived&gt;</code> from a <code>TfRefPtr&lt;Base&gt;</code> is illegal, just as it is illegal to assign a <code>Base*</code> to a <code>Derived*</code>. However, if <code>Derived</code> and <code>Base</code> are polymorphic (i.e. have virtual functions) then the analogue of a <code>dynamic_cast&lt;&gt;</code> is possible:</p>
<div class="fragment"><div class="line">dPtr = <a class="code" href="declare_handles_8h.html#a9657ab533e10437581538364b069339a">TfDynamic_cast</a>&lt;<a class="code" href="class_tf_ref_ptr.html">TfRefPtr&lt;Derived&gt;</a> &gt;(bPtr);</div></div><!-- fragment --><p>Just like a regular <code>dynamic_cast&lt;&gt;</code> operation, the <code><a class="el" href="class_tf_ref_ptr.html" title="Reference-counted smart pointer utility class.">TfRefPtr</a></code> returned by <code>TfDynamic_cast&lt;&gt;</code> points to NULL if the conversion fails, so that the operator can also be used to check types:</p>
<div class="fragment"><div class="line"><span class="keywordflow">if</span> (! <a class="code" href="declare_handles_8h.html#a9657ab533e10437581538364b069339a">TfDynamic_cast</a>&lt;<a class="code" href="class_tf_ref_ptr.html">TfRefPtr&lt;T2&gt;</a> &gt;(ptr))</div><div class="line">    <span class="comment">// complain: ptr is not of type T2</span></div></div><!-- fragment --><p>Similarly, one can use the <code>TfStatic_cast&lt;&gt;</code> operator to statically convert <code>TfRefPtrs:</code> </p>
<div class="fragment"><div class="line">dPtr = <a class="code" href="declare_handles_8h.html#a8926a712ca955cef8ae27ba0b401f0c6">TfStatic_cast</a>&lt;<a class="code" href="class_tf_ref_ptr.html">TfRefPtr&lt;Derived&gt;</a> &gt;(bPtr);</div></div><!-- fragment --><p>This is faster, but not as safe as using <code>TfDynamic_cast</code>.</p>
<p>Finally, remember that in <code>C++</code>, a <code>Derived**</code> is not a <code>Base**</code>, nor is a <code>Derived*&amp;</code> a <code>Base*&amp;</code>. This implies that</p>
<div class="fragment"><div class="line"><a class="code" href="class_tf_ref_ptr.html">TfRefPtr&lt;Base&gt;</a>*  bPtrPtr = &amp;dPtr;      <span class="comment">// compilation error</span></div><div class="line"><a class="code" href="class_tf_ref_ptr.html">TfRefPtr&lt;Base&gt;</a>&amp;  bPtrRef = dPtr;       <span class="comment">// compilation error</span></div><div class="line"><span class="keyword">const</span> <a class="code" href="class_tf_ref_ptr.html">TfRefPtr&lt;Base&gt;</a>&amp;bPtrRef = dPtr;   <span class="comment">// OK</span></div></div><!-- fragment --><p>The last initialization is legal because the compiler implicitly converts dPtr into a temporary variable of type <code>TfRefPtr&lt;Base&gt;</code>.</p>
<p><b> Thread Safety </b></p>
<p>One more comment about thread-safety: the above examples are thread-safe in the sense that if two or more threads create and destroy their <em>own</em> <code><a class="el" href="class_tf_ref_ptr.html" title="Reference-counted smart pointer utility class.">TfRefPtr</a></code> objects, the reference counts of the underlying objects are always correct; said another way, the reference count it a thread-safe quantity.</p>
<p>However, it is never safe for two threads to simultaneously try to alter the same <code><a class="el" href="class_tf_ref_ptr.html" title="Reference-counted smart pointer utility class.">TfRefPtr</a></code> object, nor can two threads safely call methods on the same underlying object unless that object itself guarantees thread safety.</p>
<p><a class="anchor" id="refPtr_Tracking"></a><b> Tracking References </b></p>
<p>The <code><a class="el" href="class_tf_ref_ptr_tracker.html" title="Provides tracking of TfRefPtr objects to particular objects.">TfRefPtrTracker</a></code> singleton can track <code><a class="el" href="class_tf_ref_ptr.html" title="Reference-counted smart pointer utility class.">TfRefPtr</a></code> objects that point to particular instances. The macros <code>TF_DECLARE_REFBASE_TRACK</code> and <code>TF_DEFINE_REFBASE_TRACK</code> are used to enable tracking. Tracking is enabled at compile time but which instances to track is chosen at runtime.</p>
<p><b> Total Encapsulation </b> <a class="anchor" id="refPtr_encapsulation"></a> If you're using <code>TfRefPtrs</code> on a type <code>T</code>, you probably want to completely forbid clients from creating their own objects of type <code>T</code>, and force them to go through <code>TfRefPtrs</code>. Such encapsulation is strongly encouraged. Here is the recommended technique:</p>
<div class="fragment"><div class="line"><span class="keyword">typedef</span> <a class="code" href="class_tf_ref_ptr.html">TfRefPtr&lt;class Simple&gt;</a> SimpleRefPtr;</div><div class="line"></div><div class="line"><span class="keyword">class </span>Simple : <span class="keyword">public</span> <a class="code" href="class_tf_ref_base.html">TfRefBase</a> {</div><div class="line"><span class="keyword">private</span>:         <span class="comment">// use protected if you plan to derive later</span></div><div class="line">    Simple();</div><div class="line">    Simple(&lt;arg-list&gt;);</div><div class="line"><span class="keyword">public</span>:</div><div class="line">    <span class="keyword">static</span> SimpleRefPtr New() {</div><div class="line">       <span class="keywordflow">return</span> TfCreateRefPtr(<span class="keyword">new</span> Simple);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keyword">static</span> SimpleRefPtr New(&lt;arg-list&gt;) {</div><div class="line">       <span class="keywordflow">return</span> TfCreateRefPtr(<span class="keyword">new</span> Simple(&lt;arg-list&gt;));</div><div class="line">    }</div><div class="line"></div><div class="line">    ~Simple();</div><div class="line">};</div></div><!-- fragment --><p>Clients can now only create objects of type <code>Simple</code> using a <code><a class="el" href="class_tf_ref_ptr.html" title="Reference-counted smart pointer utility class.">TfRefPtr</a>:</code> </p>
<div class="fragment"><div class="line">Simple    s;                                 <span class="comment">// compilation error</span></div><div class="line">SimpleRefPtr sPtr1 = <span class="keyword">new</span> Simple;                <span class="comment">// compilation error</span></div><div class="line">SimpleRefPtr sPtr2 = Simple::New();             <span class="comment">// OK</span></div><div class="line">SimpleRefPtr sPtr3 = Simple::New(&lt;arg-list&gt;);   <span class="comment">// Ok</span></div></div><!-- fragment --> 
<p class="definition">Definition in file <a class="el" href="ref_ptr_8h_source.html">refPtr.h</a>.</p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.9.6-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_1d43f220d4da368b75944030615bc443.html">pxr</a></li><li class="navelem"><a class="el" href="dir_682898b56c69f5cabb813635d1588cf1.html">base</a></li><li class="navelem"><a class="el" href="dir_dfcdafeb163cb945f0b6b2c9b02a7be3.html">tf</a></li><li class="navelem"><a class="el" href="ref_ptr_8h.html">refPtr.h</a></li>
    <li class="footer">&copy; Copyright 2023, Pixar Animation Studios. Generated on Mon Nov 20 2023 16:06:54 by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.8.15 </li>
  </ul>
</div>
</body>
</html>