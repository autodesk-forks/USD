<!-- HTML header for doxygen 1.8.15-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.15"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Universal Scene Description: Trace: Performance tracking</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="usd_style.css" rel="stylesheet" type="text/css"/>
<link rel="shortcut icon" href="https://openusd.org/images/USDIcon.ico"/>
<!-- ... other metadata & script includes ... -->
<script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript">
    DoxygenAwesomeDarkModeToggle.init()
</script>
<script type="text/javascript" src="doxygen-awesome-fragment-copy-button.js"></script>
<script type="text/javascript">
    DoxygenAwesomeFragmentCopyButton.init()
</script>
<!-- Add warning banner to top of page if current page isn't the release version -->
<script>
function AddWarningBanner() 
{
  // Get current URL
  const loc = new URL(location.href);
  // Look for URL of the format "<USD hostname>/<version|dev|release>/api/<file.html>"
  // NOTE: If versioning approach ever changes, this will need updating
  var apiIndex = loc.pathname.indexOf("/api/");
  if (apiIndex >= 0) {
    // Truncate "/api/..." off path to get preceding path and "/" index
    var truncString = loc.pathname.slice(0,apiIndex);
    // Get index of first "/" before "/api/"
    var preApiIndex = truncString.lastIndexOf("/");
    var verString = truncString.slice(preApiIndex + 1);
    // if the current page isn't the release version, add a warning banner 
    if (verString !== "release") {
      // Create alternate "release" URL for page
      // NOTE: This won't always be a valid URL, e.g. if dev release has a brand new page
      var relURL = loc.pathname.substring(0,preApiIndex) + "/release" + loc.pathname.substring(apiIndex);
      var banner = document.createElement("div");
      banner.className = "non_release_version_warning";
      if (verString === "dev") {
        banner.innerHTML = "This document is for a version of USD that is under development. See <a href='" + relURL + "'>this page</a> for the current release.";
      } else {
        // For now, we assume any other string is an older version string
        banner.innerHTML = "This document is for an older version of USD. See <a href='" + relURL + "'>this page</a> for the current release.";
      }
      document.body.insertBefore(banner,document.body.childNodes[0]);
    }
  }
} 
</script>
</head>
<body onload="AddWarningBanner()">
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="USDLogoDocs.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.15 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('trace_page_front.html','');});
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Trace: Performance tracking </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="trace_contents"></a>
Contents</h1>
<ul>
<li><a class="el" href="trace_page_front.html#trace_overview">Overview</a> </li>
<li><a class="el" href="trace_page_front.html#trace_instrumentation">Instrumentation</a> </li>
<li><a class="el" href="trace_page_front.html#trace_recording_reporting">Recording and Reporting</a> </li>
<li><a class="el" href="trace_page_front.html#trace_performance">Performance Overhead</a> </li>
<li><a class="el" href="trace_page_front.html#trace_details">Details</a></li>
</ul>
<h1><a class="anchor" id="trace_overview"></a>
Overview</h1>
<p>Defines utility classes for counting, timing, measuring, and recording events. The <a class="el" href="class_trace_collector.html" title="This is a singleton class that records TraceEvent instances and populates TraceCollection instances.">TraceCollector</a> class records <a class="el" href="class_trace_event.html" title="This represents an event recorded by a TraceCollector.">TraceEvent</a> objects. The <a class="el" href="class_trace_reporter.html" title="This class converts streams of TraceEvent objects into call trees which can then be used as a data so...">TraceReporter</a> class contains functions to generate reports on events gathered by the <a class="el" href="class_trace_collector.html" title="This is a singleton class that records TraceEvent instances and populates TraceCollection instances.">TraceCollector</a> object.</p>
<h1><a class="anchor" id="trace_instrumentation"></a>
Instrumentation</h1>
<p>Instrumentation is done by adding TRACE macros to code.</p>
<p>For example:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="trace_8h.html">pxr/base/trace/trace.h</a>&quot;</span></div><div class="line"></div><div class="line"><span class="comment">// Typical usage.</span></div><div class="line"><span class="keywordtype">void</span> Foo()</div><div class="line">{</div><div class="line">    <a class="code" href="trace_8h.html#a5b0af4118bc65ec32e2f5d2558fe90d5">TRACE_FUNCTION</a>();</div><div class="line">    ...</div><div class="line">    {</div><div class="line">        <span class="comment">// More work is done here that needs timing separated.</span></div><div class="line">        <a class="code" href="trace_8h.html#a39c16c77a53bc0aaaf4f2f39cd37f6c0">TRACE_SCOPE</a>(<span class="stringliteral">&quot;Inner Scope&quot;</span>);</div><div class="line">        ...</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><p>Python tracing is also supported: </p><div class="fragment"><div class="line"><span class="keyword">from</span> pxr <span class="keyword">import</span> Trace</div><div class="line"></div><div class="line">@Trace.TraceFunction</div><div class="line"><span class="keyword">def </span>foo():</div><div class="line">    ...</div><div class="line">    <span class="keyword">with</span> Trace.TraceScope(<span class="stringliteral">&quot;Inner Scope&quot;</span>):</div><div class="line">        ...</div></div><!-- fragment --><p>Adding Trace macros does have a small <a class="el" href="trace_page_front.html#trace_performance">overhead </a> even when tracing is disabled. Sometimes a performance sensitive function may have a slow path that is taken infrequently, but timing information is needed. In cases like this, it is possible to reduce the overhead of the instrumentation to specific scopes.</p>
<div class="fragment"><div class="line"><span class="comment">// This is an example of a performance sensitive function that has a slow path.</span></div><div class="line"><span class="keywordtype">void</span> PerformanceSensitiveFunction(<span class="keywordtype">bool</span> slowPath)</div><div class="line">{</div><div class="line">    <span class="comment">// No TRACE Macro is used in the fast path to avoid any overhead.</span></div><div class="line">    <span class="keywordflow">if</span> (slowPath) {</div><div class="line">        <span class="comment">// This will only pay the overhead cost of the trace instrumentation on</span></div><div class="line">        <span class="comment">// the slow path.</span></div><div class="line">        <a class="code" href="trace_8h.html#aec9f2bb2b5d0fd9be6ba7cddbce26cf1">TRACE_FUNCTION_SCOPE</a>(<span class="stringliteral">&quot;Slow path&quot;</span>);</div><div class="line">        ...</div><div class="line">    }</div><div class="line">    ...</div><div class="line">}</div></div><!-- fragment --><h1><a class="anchor" id="trace_recording_reporting"></a>
Recording and Reporting</h1>
<p>Recording is done through the <a class="el" href="class_trace_collector.html" title="This is a singleton class that records TraceEvent instances and populates TraceCollection instances.">TraceCollector</a> class. Enabling the collector will cause TRACE macros to record events. Reports are generated with the <a class="el" href="class_trace_reporter.html" title="This class converts streams of TraceEvent objects into call trees which can then be used as a data so...">TraceReporter</a> class. </p><div class="fragment"><div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>* argv[])</div><div class="line">{</div><div class="line">    <span class="comment">// Start recording events.</span></div><div class="line">    <a class="code" href="class_trace_collector.html#a7c6ef45a242396370e5d51e4c0ed8ec7">TraceCollector::GetInstance</a>().<a class="code" href="class_trace_collector.html#a0bd350fc68d56a8bb66c20531e7d3587">SetEnabled</a>(<span class="keyword">true</span>);</div><div class="line"></div><div class="line">    Foo();</div><div class="line">    ...</div><div class="line"></div><div class="line">    <span class="comment">// Stop recording events.</span></div><div class="line">    <a class="code" href="class_trace_collector.html#a7c6ef45a242396370e5d51e4c0ed8ec7">TraceCollector::GetInstance</a>().<a class="code" href="class_trace_collector.html#a0bd350fc68d56a8bb66c20531e7d3587">SetEnabled</a>(<span class="keyword">false</span>);</div><div class="line"></div><div class="line">    <span class="comment">// Print the ASCII report</span></div><div class="line">    ofstream reportFile(<span class="stringliteral">&quot;report.trace&quot;</span>);</div><div class="line">    <a class="code" href="class_trace_reporter.html#ad5f989cdbc2e4103bf6594f4c043625c">TraceReporter::GetGlobalReporter</a>().Report(reportFile);</div><div class="line"></div><div class="line">    <span class="comment">// Print the chrome-compatible report</span></div><div class="line">    ofstream chromeReportFile(<span class="stringliteral">&quot;report.json&quot;</span>);</div><div class="line">    <a class="code" href="class_trace_reporter.html#ad5f989cdbc2e4103bf6594f4c043625c">TraceReporter::GetGlobalReporter</a>().ReportChromeTracing(chromeReportFile);</div><div class="line">}</div></div><!-- fragment --><p>And in Python: </p><div class="fragment"><div class="line"><span class="keyword">from</span> pxr <span class="keyword">import</span> Trace</div><div class="line"></div><div class="line"><span class="comment"># Start recording events.</span></div><div class="line">Trace.Collector().enabled = <span class="keyword">True</span></div><div class="line"></div><div class="line">Foo()</div><div class="line">...</div><div class="line"></div><div class="line"><span class="comment"># Stop recording events.</span></div><div class="line">Trace.Collector().enabled = <span class="keyword">False</span></div><div class="line"></div><div class="line"><span class="comment"># Print the ASCII report</span></div><div class="line">Trace.Reporter.globalReporter.Report(<span class="stringliteral">&quot;report.trace&quot;</span>)</div><div class="line"></div><div class="line"><span class="comment"># Print the chrome-compatible report</span></div><div class="line">Trace.Reporter.globalReporter.ReportChromeTracingToFile(<span class="stringliteral">&quot;report.json&quot;</span>)</div></div><!-- fragment --><p>The default report is an aggregated call graph showing the include time, exclusive time, and call count of each scope.</p>
<p>Example Report: </p><div class="fragment"><div class="line">Tree view  ==============</div><div class="line">   inclusive    exclusive        </div><div class="line">   13.000 ms                    1 samples    MainThread</div><div class="line">   13.000 ms     4.000 ms       1 samples    | OuterScope</div><div class="line">    9.000 ms     8.000 ms       1 samples    |   InnerScope</div><div class="line">    1.000 ms     1.000 ms       2 samples    |   | Inner Scope 2</div><div class="line">   13.000 ms                    1 samples    Thread 1</div><div class="line">   13.000 ms     4.000 ms       1 samples    | OuterScope</div><div class="line">    9.000 ms     8.000 ms       1 samples    |   InnerScope</div><div class="line">    1.000 ms     1.000 ms       2 samples    |   | Inner Scope 2</div></div><!-- fragment --><p>The Chrome tracing format is also supported using the <a class="el" href="class_trace_reporter.html#aa4f518c0353299885a977a1c3e56792d" title="Generates a timeline trace report suitable for viewing in Chrome&#39;s trace viewer.">TraceReporter::ReportChromeTracing</a> method.</p>
<p>A report can also be generated from a program instrumented with libtrace using the PXR_ENABLE_GLOBAL_TRACE environment variable. If this variable is set, the <a class="el" href="class_trace_collector.html" title="This is a singleton class that records TraceEvent instances and populates TraceCollection instances.">TraceCollector</a> singleton will start recording on initialization, and a report will be written to stdout at program exit. </p><div class="fragment"><div class="line">&gt;env PXR_ENABLE_GLOBAL_TRACE=1 usdview HelloWorld.usda --quitAfterStartup</div><div class="line"></div><div class="line">Tree view  ==============</div><div class="line">   inclusive    exclusive        </div><div class="line">  358.500 ms                    1 samples    Main Thread</div><div class="line">    0.701 ms     0.701 ms       8 samples    | SdfPath::_InitWithString</div><div class="line">    0.003 ms     0.003 ms       2 samples    | {anonymous}::VtDictionaryToPython::convert</div><div class="line">  275.580 ms   275.580 ms       3 samples    | PlugPlugin::_Load</div><div class="line">    0.014 ms     0.014 ms       3 samples    | UcGetCurrentUnit</div><div class="line">    1.470 ms     0.002 ms       1 samples    | UcIsKnownUnit</div><div class="line">    1.467 ms     0.026 ms       1 samples    |   Uc::_InitUnitData [initialization]</div><div class="line">    1.442 ms     1.442 ms       1 samples    |   | Uc_Engine::GetValue</div><div class="line">    0.750 ms     0.000 ms       1 samples    | UcGetValue</div><div class="line">    0.750 ms     0.750 ms       1 samples    |   Uc_Engine::GetValue</div><div class="line">    9.141 ms     0.053 ms       1 samples    | PrCreatePathResolverForUnit</div><div class="line">    0.002 ms     0.002 ms       6 samples    |   UcIsKnownUnit</div><div class="line">    ...</div></div><!-- fragment --><p>The aggregated call graph can be accessed through <a class="el" href="class_trace_reporter.html#adbb3ebc5685d873651cae232365df0c3" title="Returns the root node of the aggregated call tree.">TraceReporter::GetAggregateTreeRoot</a>. The non-aggregated call graph can be access through <a class="el" href="class_trace_reporter.html#aff02407d216138b36773bebb30d47dd1" title="Returns the event call tree.">TraceReporter::GetEventTree</a>.</p>
<h1><a class="anchor" id="trace_performance"></a>
Performance Overhead</h1>
<p>Adding trace instrumentation macros has the following overhead: </p><ul>
<li>
When tracing is disabled, <a class="el" href="trace_8h.html#a5b0af4118bc65ec32e2f5d2558fe90d5" title="Records a timestamp when constructed and a timespan event when destructed, using the name of the func...">TRACE_FUNCTION()</a>, <a class="el" href="trace_8h.html#aec9f2bb2b5d0fd9be6ba7cddbce26cf1" title="Records a timestamp when constructed and a timespan event when destructed, using the name of the func...">TRACE_FUNCTION_SCOPE()</a>, and <a class="el" href="trace_8h.html#a39c16c77a53bc0aaaf4f2f39cd37f6c0" title="Records a timestamp when constructed and a timespan event when destructed, using name as the key.">TRACE_SCOPE()</a> initialize 16 bytes of stack memory, read an atomic int, and have 2 branches.  </li>
<li>
When tracing is enabled, overhead of <a class="el" href="trace_8h.html#a5b0af4118bc65ec32e2f5d2558fe90d5" title="Records a timestamp when constructed and a timespan event when destructed, using the name of the func...">TRACE_FUNCTION()</a>, <a class="el" href="trace_8h.html#aec9f2bb2b5d0fd9be6ba7cddbce26cf1" title="Records a timestamp when constructed and a timespan event when destructed, using the name of the func...">TRACE_FUNCTION_SCOPE()</a>, and <a class="el" href="trace_8h.html#a39c16c77a53bc0aaaf4f2f39cd37f6c0" title="Records a timestamp when constructed and a timespan event when destructed, using name as the key.">TRACE_SCOPE()</a> is about 100 times larger than the disabled case. (.33ns vs 33ns in microbenchmarks on our workstations).  </li>
<li>
The dynamic versions of the macros <a class="el" href="trace_8h.html#a024be3c93cc9f0ae55494e619992b59e" title="Records a begin event when constructed and an end event when destructed, using name of the function o...">TRACE_FUNCTION_DYNAMIC()</a>, <a class="el" href="trace_8h.html#a9e691dcf1121767f4b93c0615f64084c" title="Records a begin event when constructed and an end event when destructed, using name as the key.">TRACE_SCOPE_DYNAMIC()</a> have a much higher overhead than the static versions. The reason for this is that for the static versions, the names of the scopes are compiled as constexpr data, but the dynamic versions construct strings at runtime. This overhead of dynamic macros is true whether tracing is enabled or not. Because of this, the static versions should be preferred whenever possible.  </li>
</ul>
<p>It is possible to disable TRACE macros from generating code by defining TRACE_DISABLE in the preprocessor.</p>
<p>The <a class="el" href="class_trace_collector.html" title="This is a singleton class that records TraceEvent instances and populates TraceCollection instances.">TraceCollector</a> class and TRACE macros are thread-safe.</p>
<h1><a class="anchor" id="trace_details"></a>
Details</h1>
<p>For more detailed information see <a class="el" href="trace_page_detail.html">Trace Details</a> </p>
</div></div><!-- PageDoc -->
</div><!-- contents -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.9.6-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">&copy; Copyright 2023, Pixar Animation Studios. Generated on Mon Nov 20 2023 16:06:57 by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.8.15 </li>
  </ul>
</div>
</body>
</html>