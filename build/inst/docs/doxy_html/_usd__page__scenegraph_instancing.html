<!-- HTML header for doxygen 1.8.15-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.15"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Universal Scene Description: Scenegraph Instancing</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="usd_style.css" rel="stylesheet" type="text/css"/>
<link rel="shortcut icon" href="https://openusd.org/images/USDIcon.ico"/>
<!-- ... other metadata & script includes ... -->
<script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript">
    DoxygenAwesomeDarkModeToggle.init()
</script>
<script type="text/javascript" src="doxygen-awesome-fragment-copy-button.js"></script>
<script type="text/javascript">
    DoxygenAwesomeFragmentCopyButton.init()
</script>
<!-- Add warning banner to top of page if current page isn't the release version -->
<script>
function AddWarningBanner() 
{
  // Get current URL
  const loc = new URL(location.href);
  // Look for URL of the format "<USD hostname>/<version|dev|release>/api/<file.html>"
  // NOTE: If versioning approach ever changes, this will need updating
  var apiIndex = loc.pathname.indexOf("/api/");
  if (apiIndex >= 0) {
    // Truncate "/api/..." off path to get preceding path and "/" index
    var truncString = loc.pathname.slice(0,apiIndex);
    // Get index of first "/" before "/api/"
    var preApiIndex = truncString.lastIndexOf("/");
    var verString = truncString.slice(preApiIndex + 1);
    // if the current page isn't the release version, add a warning banner 
    if (verString !== "release") {
      // Create alternate "release" URL for page
      // NOTE: This won't always be a valid URL, e.g. if dev release has a brand new page
      var relURL = loc.pathname.substring(0,preApiIndex) + "/release" + loc.pathname.substring(apiIndex);
      var banner = document.createElement("div");
      banner.className = "non_release_version_warning";
      if (verString === "dev") {
        banner.innerHTML = "This document is for a version of USD that is under development. See <a href='" + relURL + "'>this page</a> for the current release.";
      } else {
        // For now, we assume any other string is an older version string
        banner.innerHTML = "This document is for an older version of USD. See <a href='" + relURL + "'>this page</a> for the current release.";
      }
      document.body.insertBefore(banner,document.body.childNodes[0]);
    }
  }
} 
</script>
</head>
<body onload="AddWarningBanner()">
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="USDLogoDocs.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.15 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('_usd__page__scenegraph_instancing.html','');});
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Scenegraph Instancing </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="Usd_ScenegraphInstancing_Overview"></a>
Overview</h1>
<p>USD's instancing functionality allows prims that bring in common scene description via <a href="https://openusd.org/release/glossary.html#usdglossary-compositionarcs">composition arcs</a> to share those parts of the scenegraph, rather than having them duplicated for each prim. This can greatly improve performance in cases where many copies of the same asset are brought in to a scene via composition. For example, a parking lot scene may use references to bring in the same car model (or set of car models) hundreds or thousands of times to fully populate the lot. In cases like these, instancing can provide significant performance benefits.</p>
<p><a class="anchor" id="image_overview_scenegraph"></a></p><div class="image">
<img src="Uninstanced_vs_Instanced.png" alt="Uninstanced_vs_Instanced.png"/>
<div class="caption">
Uninstanced vs. Instanced Scenegraph</div></div>
<p> With instancing, the hierarchy of prims from the referenced Car model is exposed beneath a single prototype prim, instead of having <em>n</em> copies of that hierarchy beneath each of the Car prims in the scene. This reduces the size of the scenegraph, which reduces the time needed to load a <a class="el" href="class_usd_stage.html" title="The outermost container for scene description, which owns and presents composed prims as a scenegraph...">UsdStage</a> as well as the memory it consumes.</p>
<p>Consumers can take advantage of the shared scenegraph to reduce the amount of processing they need to do. For example, a consumer that needs to compute the bounding box for all of the Car prims in the scene could compute the bounding box for the shared scenegraph just once and reuse that result instead of redoing the same computation for each one. To allow the scenegraph to be shared in this way, instancing restricts the ability to override prims and properties in the prototype prim on a per-instance basis. In this example, consumers would not be able to add, remove, or override prims beneath any of the Car prims in the scene. With this restriction, instancing is able to provide higher degrees of scalability; the benefits become more and more significant as the number of Car prims increases, or as the number of prims beneath the referenced Car model grows.</p>
<h1><a class="anchor" id="Usd_ScenegraphInstancing_Instancing"></a>
Explicit Instances, Implicit Prototypes</h1>
<p>Prims that share parts of the scenegraph through instancing are called "instance" prims. Each of these instance prims are associated with a "prototype" prim that serves as the root of the shared scenegraph. A single prototype prim may have many associated instances, all of which share the same scenegraph.</p>
<p>Users do not explicitly set up the network of prototype and instance prims. Instead, users mark the prims they want to be instanced with metadata that tags them as "instanceable." <a class="el" href="class_usd_stage.html" title="The outermost container for scene description, which owns and presents composed prims as a scenegraph...">UsdStage</a> will analyze these prims to determine which have scenegraph in common based on their composition structure, then dynamically create prototype prims for each group of compatible instances. This "explicit instance, implicit prototype" scheme provides a simple and flexible way for adding instanced assets to scenes. See <a class="el" href="_usd__page__scenegraph_instancing.html#Usd_ScenegraphInstancing_Instanceable">Making Prims Instanceable</a> for information on how to tag prims for instancing.</p>
<center> <a class="anchor" id=""></a>
<table border="0" style="table-layout: fixed;" width="75%">
<caption>Uninstanced vs. Instanced Scene Description</caption>
<tr>
<td valign="top"><div class="fragment"><div class="line"><span class="preprocessor">### ParkingLot.usd</span></div><div class="line"></div><div class="line"><span class="preprocessor">#usda 1.0</span></div><div class="line"></div><div class="line">def <span class="stringliteral">&quot;ParkingLot&quot;</span></div><div class="line">{</div><div class="line">    def <span class="stringliteral">&quot;Car_1&quot;</span> (references = @./Car.usd@&lt;/Car&gt;)</div><div class="line">    {</div><div class="line">    }</div><div class="line"></div><div class="line">    def <span class="stringliteral">&quot;Car_2&quot;</span> (references = @./Car.usd@&lt;/Car&gt;)</div><div class="line">    {</div><div class="line">    }</div><div class="line"></div><div class="line"><span class="preprocessor">    # ...</span></div><div class="line"></div><div class="line">    def <span class="stringliteral">&quot;Car_n&quot;</span> (references = @./Car.usd@&lt;/Van&gt;)</div><div class="line">    {</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment -->  </td><td valign="top"><div class="fragment"><div class="line"><span class="preprocessor">### ParkingLot.usd</span></div><div class="line"></div><div class="line"><span class="preprocessor">#usda 1.0</span></div><div class="line"></div><div class="line">def <span class="stringliteral">&quot;ParkingLot&quot;</span></div><div class="line">{</div><div class="line">    def <span class="stringliteral">&quot;Car_1&quot;</span> (</div><div class="line">        instanceable = <span class="keyword">true</span></div><div class="line">        references = @./Car.usd@&lt;/Car&gt;</div><div class="line">    )</div><div class="line">    {</div><div class="line">    }</div><div class="line"></div><div class="line">    def <span class="stringliteral">&quot;Car_2&quot;</span> (</div><div class="line">        instanceable = <span class="keyword">true</span></div><div class="line">        references = @./Car.usd@&lt;/Car&gt;</div><div class="line">    )</div><div class="line">    {</div><div class="line">    }</div><div class="line"></div><div class="line"><span class="preprocessor">    # ...</span></div><div class="line"></div><div class="line">    def <span class="stringliteral">&quot;Car_n&quot;</span> (</div><div class="line">        instanceable = <span class="keyword">true</span></div><div class="line">        references = @./Car.usd@&lt;/Car&gt;</div><div class="line">    )</div><div class="line">    {</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment -->   </td></tr>
</table>
</center><p>This is a simple example of what the scene description in a .usd file might look like for the scenegraph above. In this case, <a class="el" href="class_usd_stage.html" title="The outermost container for scene description, which owns and presents composed prims as a scenegraph...">UsdStage</a> will recognize that all of the instanceable Car prims reference the same Car model and will have the same scenegraph hierarchy. <a class="el" href="class_usd_stage.html" title="The outermost container for scene description, which owns and presents composed prims as a scenegraph...">UsdStage</a> will then generate a prototype prim /__Prototype_1 to contain this common hierarchy and associate the Car instances with this prototype.</p>
<p>Prototype prims do not exist in scene description &ndash; they are generated and managed internally by <a class="el" href="class_usd_stage.html" title="The outermost container for scene description, which owns and presents composed prims as a scenegraph...">UsdStage</a>. This allows <a class="el" href="class_usd_stage.html" title="The outermost container for scene description, which owns and presents composed prims as a scenegraph...">UsdStage</a> to create and remove prototypes as needed in response to scene description changes. For example, if some of the Car prims in ParkingLot.usd were changed to reference different assets, <a class="el" href="class_usd_stage.html" title="The outermost container for scene description, which owns and presents composed prims as a scenegraph...">UsdStage</a> would generate new prototype prims as needed. See <a class="el" href="_usd__page__scenegraph_instancing.html#Usd_ScenegraphInstancing_Prototypes">Finding and Traversing Prototypes</a> for information on how to use prototype prims.</p>
<dl class="section warning"><dt>Warning</dt><dd>Because prototype prims are dynamically generated, the name of a prototype prim associated with an instance is not stable and may vary from run-to-run. Consumers should not save or hard-code the paths to prims in prototypes, but can use the API described below if they need to determine an instance's prototype at runtime.</dd></dl>
<h1><a class="anchor" id="Usd_ScenegraphInstancing_Querying"></a>
Working with Instancing</h1>
<p>This section goes into more detail about instance and prototype prims and the API for working with them. The following example will be used throughout:</p>
<center> <a class="anchor" id=""></a>
<table border="0">
<caption>Example Scene Description and Scenegraph</caption>
<tr>
<td valign="top"><div class="fragment"><div class="line"><span class="preprocessor">### ParkingLot.usd</span></div><div class="line"></div><div class="line"><span class="preprocessor">#usda 1.0</span></div><div class="line"></div><div class="line">def <span class="stringliteral">&quot;ParkingLot&quot;</span></div><div class="line">{</div><div class="line">    def <span class="stringliteral">&quot;Car_1&quot;</span> (</div><div class="line">        instanceable = <span class="keyword">true</span></div><div class="line">        references = @./Car.usd@&lt;/Car&gt;</div><div class="line">    )</div><div class="line">    {</div><div class="line">        color3f color = (1, 0, 0)</div><div class="line">    }</div><div class="line"></div><div class="line">    def <span class="stringliteral">&quot;Car_2&quot;</span> (</div><div class="line">        instanceable = <span class="keyword">true</span></div><div class="line">        references = @./Car.usd@&lt;/Car&gt;</div><div class="line">    )</div><div class="line">    {</div><div class="line">        color3f color = (0, 1, 0)</div><div class="line">    }</div><div class="line"></div><div class="line">    def <span class="stringliteral">&quot;Car_3&quot;</span> (</div><div class="line">        references = @./Car.usd@&lt;/Car&gt;</div><div class="line">    )</div><div class="line">    {</div><div class="line">        color3f color = (0, 0, 1)</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><div class="fragment"><div class="line"><span class="preprocessor">### Car.usd</span></div><div class="line"></div><div class="line"><span class="preprocessor">#usda 1.0</span></div><div class="line"></div><div class="line">def <span class="stringliteral">&quot;Car&quot;</span></div><div class="line">{</div><div class="line">    color3f color = (0, 0, 0)</div><div class="line"></div><div class="line">    def Mesh <span class="stringliteral">&quot;Body&quot;</span></div><div class="line">    {</div><div class="line">        color3f color = (0, 0, 0)</div><div class="line">    }</div><div class="line"></div><div class="line">    def Mesh <span class="stringliteral">&quot;Door&quot;</span></div><div class="line">    {</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment -->  </td><td valign="middle"><div class="image">
<img src="Instancing_Example.png" alt="Instancing_Example.png"/>
</div>
   </td></tr>
</table>
</center><h2><a class="anchor" id="Usd_ScenegraphInstancing_Instanceable"></a>
Making Prims Instanceable</h2>
<p><a class="el" href="class_usd_stage.html" title="The outermost container for scene description, which owns and presents composed prims as a scenegraph...">UsdStage</a> can only create prototype prims for portions of the scenegraph that are brought into a scene via a composition arc. Because of this, a prim must use at least one composition arc in order to be eligible for instancing.</p>
<p>Prims may be marked as instanceable by using <a class="el" href="class_usd_prim.html#ad791f3246d4e5bf72e036df7495ec94d" title="Author &#39;instanceable&#39; metadata for this prim at the current EditTarget.">UsdPrim::SetInstanceable</a> or <a class="el" href="class_sdf_prim_spec.html#a480003e9b19d88e2e959ec5a6c4620eb" title="Sets the value for the prim&#39;s instanceable flag.">SdfPrimSpec::SetInstanceable</a>. If no value is explicitly authored, this value defaults to <code>false</code>.</p>
<p>The "instanceable" metadata is composed like all other metadata in USD, so it can be authored on different layers and have its value overridden by stronger layers. For example, a user could author their "instanceable" metadata in a session layer to see the effects of enabling (or disabling) instancing on prims in a scene without editing that scene directly.</p>
<h2><a class="anchor" id="Usd_ScenegraphInstancing_Instances"></a>
Classifying Prims with Instancing</h2>
<p>Consumers can check if a <a class="el" href="class_usd_prim.html" title="UsdPrim is the sole persistent scenegraph object on a UsdStage, and is the embodiment of a &quot;Prim&quot; as ...">UsdPrim</a> is an instance with an associated prototype using the following API.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Function  </th><th class="markdownTableHeadNone">Purpose  </th><th class="markdownTableHeadNone">Example   </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><a class="el" href="class_usd_prim.html#a802acbcafc0625377d483931ec4fb202" title="Return true if this prim is an instance of a prototype, false otherwise.">UsdPrim::IsInstance</a>  </td><td class="markdownTableBodyNone">Check if prim is an instance.  </td><td class="markdownTableBodyNone">Returns true for Car_1 and Car_2 since they are instances, but returns false for Car_3.   </td></tr>
</table>
<h2><a class="anchor" id="Usd_ScenegraphInstancing_Prototypes"></a>
Finding and Traversing Prototypes</h2>
<p>A prototype prim is a special <a class="el" href="class_usd_prim.html" title="UsdPrim is the sole persistent scenegraph object on a UsdStage, and is the embodiment of a &quot;Prim&quot; as ...">UsdPrim</a> whose sole purpose is to serve as the parent for the scenegraph shared by its associated instance prims. The following API can be used to retrieve prototype prims or determine whether a prim is part of a shared prototype.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Function  </th><th class="markdownTableHeadNone">Purpose  </th><th class="markdownTableHeadNone">Example   </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><a class="el" href="class_usd_stage.html#aedabd9cb88feca10c5fa96c7454df493" title="Returns all native instancing prototype prims.">UsdStage::GetPrototypes</a>  </td><td class="markdownTableBodyNone">Return a list of all prototype prims on the stage  </td><td class="markdownTableBodyNone">Returns the prim /__Prototype_1   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><a class="el" href="class_usd_prim.html#a5589fb9930ddf2f0ee87f9e6cde87dff" title="If this prim is an instance, return the UsdPrim for the corresponding prototype.">UsdPrim::GetPrototype</a>  </td><td class="markdownTableBodyNone">If prim is an instance, get the corresponding prototype prim.  </td><td class="markdownTableBodyNone">Returns prim /__Prototype_1 for Car_1 or Car_2, an invalid <a class="el" href="class_usd_prim.html" title="UsdPrim is the sole persistent scenegraph object on a UsdStage, and is the embodiment of a &quot;Prim&quot; as ...">UsdPrim</a> for all other prims, including Car_3.   </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><a class="el" href="class_usd_prim.html#a68b802c9624512af6a71de788a8d8861" title="Return true if this prim is an instancing prototype prim, false otherwise.">UsdPrim::IsPrototype</a>  </td><td class="markdownTableBodyNone">Check if this prim is a prototype prim.  </td><td class="markdownTableBodyNone">Returns true for prim /__Prototype_1, false for all other prims.   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><a class="el" href="class_usd_prim.html#a711679d7f780d1160d0b33a1e2f92268" title="Return true if this prim is a prototype prim or a descendant of a prototype prim, false otherwise.">UsdPrim::IsInPrototype</a>  </td><td class="markdownTableBodyNone">Check if this prim is in a subtree rooted at a prototype prim.  </td><td class="markdownTableBodyNone">Returns true for prims /__Prototype_1, /__Prototype_1/Body, and /__Prototype_1/Door, false for all other prims.   </td></tr>
</table>
<p>Prototype prims do not have metadata or properties, only children prims. Prototype prims have root prim paths (e.g., /__Prototype_1) that can be used with <a class="el" href="class_usd_stage.html#a6ceb556070804b712c01a7968f925735" title="Return the UsdPrim at path, or an invalid UsdPrim if none exists.">UsdStage::GetPrimAtPath</a>. However, they are considered siblings to the pseudo-root in the scenegraph. Because of this, they will not be returned when using <a class="el" href="class_usd_stage.html#adba675b55f41cc1b305bed414fc4f178" title="Traverse the active, loaded, defined, non-abstract prims on this stage depth-first.">UsdStage::Traverse</a> or when calling <a class="el" href="class_usd_prim.html#a2619563fc9180d8ead597944fd7f6ec7" title="Return this prim&#39;s active, loaded, defined, non-abstract children as an iterable range.">UsdPrim::GetChildren</a> on the pseudo-root. Consumers can access prototype prims via <a class="el" href="class_usd_prim.html#a5589fb9930ddf2f0ee87f9e6cde87dff" title="If this prim is an instance, return the UsdPrim for the corresponding prototype.">UsdPrim::GetPrototype</a> or <a class="el" href="class_usd_stage.html#aedabd9cb88feca10c5fa96c7454df493" title="Returns all native instancing prototype prims.">UsdStage::GetPrototypes</a> instead.</p>
<dl class="section warning"><dt>Warning</dt><dd>Because prototype prims are dynamically generated, the name of a prototype prim associated with an instance is not stable and may vary from run to run. Consumers should not save or hard-code the paths to prims in prototypes, but can use the API described below if they need to determine an instance's prototype at runtime.</dd></dl>
<div class="fragment"><div class="line">&gt;&gt;&gt; stage = Usd.Stage.Open(<span class="stringliteral">&#39;ParkingLot.usd&#39;</span>)</div><div class="line">&gt;&gt;&gt; stage.GetPrototypes()</div><div class="line">[Usd.Prim(&lt;/__Prototype_1&gt;)]</div><div class="line"></div><div class="line"><span class="comment"># Prototype prims are not included in stage traversals.  Note how the below</span></div><div class="line"><span class="comment"># functions do not include the prototype prims above.</span></div><div class="line">&gt;&gt;&gt; list(stage.Traverse())</div><div class="line">[Usd.Prim(&lt;/ParkingLot&gt;), Usd.Prim(&lt;/ParkingLot/Car_1&gt;), Usd.Prim(&lt;/ParkingLot/Car_2&gt;), Usd.Prim(&lt;/ParkingLot/Car_3&gt;), Usd.Prim(&lt;/ParkingLot/Car_3/Body&gt;), Usd.Prim(&lt;/ParkingLot/Car_3/Door&gt;)]</div><div class="line"></div><div class="line">&gt;&gt;&gt; stage.GetPseudoRoot().GetChildren()</div><div class="line">[Usd.Prim(&lt;/ParkingLot&gt;)]</div></div><!-- fragment --><p><a class="el" href="class_usd_stage.html" title="The outermost container for scene description, which owns and presents composed prims as a scenegraph...">UsdStage</a> arranges the scenegraph so that instance prims do not have any descendant prims; these prims are instead encapsulated beneath prototype prims. Consumers can use <a class="el" href="class_usd_prim.html#a5589fb9930ddf2f0ee87f9e6cde87dff" title="If this prim is an instance, return the UsdPrim for the corresponding prototype.">UsdPrim::GetPrototype</a> to get an instance's prototype prim, then traverse its children the same way as with other prims, using <a class="el" href="class_usd_prim.html#a2619563fc9180d8ead597944fd7f6ec7" title="Return this prim&#39;s active, loaded, defined, non-abstract children as an iterable range.">UsdPrim::GetChildren</a>, <a class="el" href="class_usd_prim_range.html" title="An forward-iterable range that traverses a subtree of prims rooted at a given prim in depth-first ord...">UsdPrimRange</a> or similar facilities.</p>
<div class="fragment"><div class="line">&gt;&gt;&gt; stage = Usd.Stage.Open(<span class="stringliteral">&#39;ParkingLot.usd&#39;</span>)</div><div class="line"></div><div class="line"><span class="comment"># Car_1 doesn&#39;t make any child prims available since it&#39;s an instance prim;</span></div><div class="line"><span class="comment"># its children in the scenegraph are parented beneath the prototype prim.</span></div><div class="line">&gt;&gt;&gt; car_1 = stage.GetPrimAtPath(<span class="stringliteral">&#39;/ParkingLot/Car_1&#39;</span>)</div><div class="line">&gt;&gt;&gt; car_1.IsInstance()</div><div class="line"><span class="keyword">True</span></div><div class="line">&gt;&gt;&gt; car_1.GetChildren()</div><div class="line">[]</div><div class="line"></div><div class="line"><span class="comment"># Consumers can query the instance&#39;s prototype for its child prims.</span></div><div class="line">&gt;&gt;&gt; car_1.GetPrototype().GetChildren()</div><div class="line">[Usd.Prim(&lt;/__Prototype_1/Body&gt;), Usd.Prim(&lt;/__Prototype_1/Door&gt;)]</div><div class="line">&gt;&gt;&gt; list(Usd.PrimRange(car_1.GetPrototype()))</div><div class="line">[Usd.Prim(&lt;/__Prototype_1&gt;), Usd.Prim(&lt;/__Prototype_1/Body&gt;), Usd.Prim(&lt;/__Prototype_1/Door&gt;)]</div><div class="line"></div><div class="line"><span class="comment"># Car_3&#39;s child prims can be accessed directly since it&#39;s not an instance prim.</span></div><div class="line">&gt;&gt;&gt; car_3 = stage.GetPrimAtPath(<span class="stringliteral">&#39;/ParkingLot/Car_3&#39;</span>)</div><div class="line">&gt;&gt;&gt; car_3.IsInstance()</div><div class="line"><span class="keyword">False</span></div><div class="line">&gt;&gt;&gt; car_3.GetChildren()</div><div class="line">[Usd.Prim(&lt;/ParkingLot/Car_3/Body&gt;), Usd.Prim(&lt;/ParkingLot/Car_3/Door&gt;)]</div></div><!-- fragment --><h2><a class="anchor" id="Usd_ScenegraphInstancing_InstanceProxies"></a>
Traversing Into Instances with Instance Proxies</h2>
<p>An instance proxy is a <a class="el" href="class_usd_prim.html" title="UsdPrim is the sole persistent scenegraph object on a UsdStage, and is the embodiment of a &quot;Prim&quot; as ...">UsdPrim</a> that represents a descendant prim beneath an instance, even though no such prim actually exists in the scenegraph. Instance proxies allow consumers to work with the scenegraph as if instancing were not being used, while retaining the load time and memory usage benefits of instancing.</p>
<p>An instance proxy prim behaves the same as the corresponding prim in the prototype. However, an instance proxy retains context about the instance being traversed so they appear to be a prim beneath an instance: its path is a descendant of the instance being traversed instead of a descendant of a prototype prim. Consumers should generally be able to use instance proxies anywhere a <a class="el" href="class_usd_prim.html" title="UsdPrim is the sole persistent scenegraph object on a UsdStage, and is the embodiment of a &quot;Prim&quot; as ...">UsdPrim</a> is used. The primary exception is that editing scene description via instance proxies and their properties is not allowed.</p>
<p>Calling <a class="el" href="class_usd_stage.html#a6ceb556070804b712c01a7968f925735" title="Return the UsdPrim at path, or an invalid UsdPrim if none exists.">UsdStage::GetPrimAtPath</a> with a path to a descendant of an instance prim will return an instance proxy if a corresponding prim exists in that instance's prototype. By default, the various prim traversal facilities like <a class="el" href="class_usd_prim.html#a2619563fc9180d8ead597944fd7f6ec7" title="Return this prim&#39;s active, loaded, defined, non-abstract children as an iterable range.">UsdPrim::GetChildren</a> and <a class="el" href="class_usd_prim_range.html" title="An forward-iterable range that traverses a subtree of prims rooted at a given prim in depth-first ord...">UsdPrimRange</a> do not return instance proxies.</p>
<p><a class="el" href="prim_flags_8h.html#ac34c7dc1a577a7d9b15c5a37e71317f2" title="This is an overloaded member function, provided for convenience. It differs from the above function o...">UsdTraverseInstanceProxies</a> can be used to enable this functionality. By default, this uses the same <a class="el" href="prim_flags_8h.html#a29cc22af3e47af74a71814d9cca1c1fe" title="The default predicate used for prim traversals in methods like UsdPrim::GetChildren,...">UsdPrimDefaultPredicate</a> used by other traversal functions, but it can be combined with other <a class="el" href="prim_flags_8h.html#Usd_PrimFlags">Usd_PrimFlags</a> predicates; for example, combining it with <a class="el" href="prim_flags_8h.html#ae3c3c2a67cd47af7d91847a77f806506" title="Predicate that includes all prims.">UsdPrimAllPrimsPredicate</a> would yield the same filtering behavior as <a class="el" href="class_usd_prim.html#a0173b7fe85d33e147f820033f4b08f0e" title="Return all this prim&#39;s children as an iterable range.">UsdPrim::GetAllChildren</a>, but with instance proxies enabled.</p>
<div class="fragment"><div class="line">&gt;&gt;&gt; stage = Usd.Stage.Open(<span class="stringliteral">&#39;ParkingLot.usd&#39;</span>)</div><div class="line"></div><div class="line"><span class="comment"># Car_1 doesn&#39;t make any child prims available by default since it&#39;s an</span></div><div class="line"><span class="comment"># instance prim.</span></div><div class="line">&gt;&gt;&gt; car_1 = stage.GetPrimAtPath(<span class="stringliteral">&#39;/ParkingLot/Car_1&#39;</span>)</div><div class="line">&gt;&gt;&gt; car_1.IsInstance()</div><div class="line"><span class="keyword">True</span></div><div class="line">&gt;&gt;&gt; car_1.GetChildren()</div><div class="line">[]</div><div class="line"></div><div class="line"><span class="comment"># Use Usd.TraverseInstanceProxies to enable instance proxies with the same </span></div><div class="line"><span class="comment"># filtering that UsdPrim.GetChildren would do.</span></div><div class="line">&gt;&gt;&gt; car_1.GetFilteredChildren(Usd.TraverseInstanceProxies())</div><div class="line">[Usd.Prim(&lt;/ParkingLot/Car_1/Body&gt;), Usd.Prim(&lt;/ParkingLot/Car_1/Door&gt;)]</div><div class="line"></div><div class="line"><span class="comment"># Calling Usd.Stage.GetPrimAtPath with the path of a prim beneath an</span></div><div class="line"><span class="comment"># instance will also return an instance proxy.</span></div><div class="line">&gt;&gt;&gt; car_1_body = stage.GetPrimAtPath(<span class="stringliteral">&#39;/ParkingLot/Car_1/Body&#39;</span>)</div><div class="line">&gt;&gt;&gt; car_1_body</div><div class="line">Usd.Prim(&lt;/ParkingLot/Car_1/Body&gt;)</div><div class="line">&gt;&gt;&gt; car_1_body.IsInstanceProxy()</div><div class="line"><span class="keyword">True</span></div><div class="line"></div><div class="line"><span class="comment"># Unlike prims in prototypes, you can walk up an instance proxy&#39;s parent prims</span></div><div class="line"><span class="comment"># to find its owning instance.</span></div><div class="line">&gt;&gt;&gt; car_1_body.GetParent()</div><div class="line">Usd.Prim(&lt;/ParkingLot/Car_1&gt;)</div><div class="line"></div><div class="line"><span class="comment"># From an instance proxy, you can retrieve the corresponding prim in the</span></div><div class="line"><span class="comment"># instance&#39;s prototype.</span></div><div class="line">&gt;&gt;&gt; car_1_body.GetPrimInPrototype()</div><div class="line">Usd.Prim(&lt;/__Prototype_1/Body&gt;)</div><div class="line"></div><div class="line"><span class="comment"># Instance proxies can be used for read-only operations anywhere a Usd.Prim</span></div><div class="line"><span class="comment"># is used.</span></div><div class="line">&gt;&gt;&gt; img = UsdGeom.Imageable(car_1_body)</div><div class="line">&gt;&gt;&gt; img.ComputeLocalToWorldTransform(Usd.TimeCode.Default())</div><div class="line">Gf.Matrix4d(...)</div><div class="line"></div><div class="line">&gt;&gt;&gt; xfCache = UsdGeom.XformCache()</div><div class="line">&gt;&gt;&gt; xfCache.GetLocalToWorldTransform(car_1_body)</div><div class="line">Gf.Matrix4d(...)</div></div><!-- fragment --><h2><a class="anchor" id="Usd_ScenegraphInstancing_Editing"></a>
Editing Instances and Prototypes</h2>
<p>Properties and metadata (e.g., variant selections) on instance prims can be edited and overridden like any other prim. However, properties and metadata on descendant prims beneath instance prims cannot be overridden. Since prototype prims are dynamically generated and do not exist in scene description, overriding properties and metadata on prototypes or prims in prototypes is also not allowed. Attempting to make these restricted changes via the USD API will result in coding errors. Any existing overrides in scene description will be silently ignored.</p>
<div class="fragment"><div class="line">&gt;&gt;&gt; stage = Usd.Stage.Open(<span class="stringliteral">&#39;ParkingLot.usd&#39;</span>)</div><div class="line"></div><div class="line"><span class="comment"># Properties on an instance can be overridden as expected.</span></div><div class="line">&gt;&gt;&gt; car1Color = stage.GetPrimAtPath(<span class="stringliteral">&#39;/ParkingLot/Car_1&#39;</span>).GetAttribute(<span class="stringliteral">&#39;color&#39;</span>)</div><div class="line">&gt;&gt;&gt; car1Color.Get()</div><div class="line">Gf.Vec3f(1.0, 0.0, 0.0)</div><div class="line">&gt;&gt;&gt; car1Color.Set((1.0, 1.0, 1.0))</div><div class="line"><span class="keyword">True</span></div><div class="line">&gt;&gt;&gt; car1Color.Get()</div><div class="line">Gf.Vec3f(1.0, 1.0, 1.0)</div><div class="line"></div><div class="line"><span class="comment"># Properties on prims in prototypes cannot be overridden. This is also the case</span></div><div class="line"><span class="comment"># when accessing the property via an instance proxy.</span></div><div class="line">&gt;&gt;&gt; prototype = stage.GetPrimAtPath(<span class="stringliteral">&#39;/ParkingLot/Car_1&#39;</span>).GetPrototype()</div><div class="line">&gt;&gt;&gt; prototypeBodyColor = prototype.GetChild(<span class="stringliteral">&#39;Body&#39;</span>).GetAttribute(<span class="stringliteral">&#39;color&#39;</span>)</div><div class="line">&gt;&gt;&gt; prototypeBodyColor.Get()</div><div class="line">Gf.Vec3f(0.0, 0.0, 0.0)</div><div class="line">&gt;&gt;&gt; prototypeBodyColor.Set((1.0, 1.0, 1.0))</div><div class="line">pixar.Tf.ErrorException</div><div class="line"></div><div class="line">&gt;&gt;&gt; instanceProxyBody = stage.GetPrimAtPath(<span class="stringliteral">&#39;/ParkingLot/Car_1/Body&#39;</span>)</div><div class="line">&gt;&gt;&gt; instanceProxyBodyColor = instanceProxyBody.GetAttribute(<span class="stringliteral">&#39;color&#39;</span>)</div><div class="line">&gt;&gt;&gt; instanceProxyBodyColor.Get()</div><div class="line">Gf.Vec3f(0.0, 0.0, 0.0)</div><div class="line">&gt;&gt;&gt; instanceProxyBodyColor.Set((1.0, 1.0, 1.0))</div><div class="line">pixar.Tf.ErrorException</div></div><!-- fragment --><p>These restrictions ensure that the scenegraph in a prototype prim can be shared by all instances. If an instance-specific edit to a prim in a prototype is needed, that instance must be made un-instanceable (see <a class="el" href="_usd__page__scenegraph_instancing.html#Usd_ScenegraphInstancing_Instanceable">Making Prims Instanceable</a>) so that it will no longer participate in instancing.</p>
<p>Although "editing prototypes" is disallowed, USD's composition arcs can be used to achieve many of the same effects. For example, a consumer could add inherit or specializes arcs to instances, then make edits to the class targeted by those arcs. Those edits would then affect all of the specified instances.</p>
<h2><a class="anchor" id="Usd_ScenegraphInstancing_TargetsAndConnections"></a>
Relationship Targets and Attribute Connections</h2>
<p>Relationships and attributes may have authored target and connection paths that point to objects beneath an instance prim. In these cases, the API for retrieving these paths, such as <a class="el" href="class_usd_relationship.html#aaa227b81fdab5fe41bcc0ca21133a0f8" title="Compose this relationship&#39;s targets and fill targets with the result.">UsdRelationship::GetTargets</a> or <a class="el" href="class_usd_attribute.html#ab6384fe8ac90bf18c8d781e139a7d813" title="Compose this attribute&#39;s connections and fill sources with the result.">UsdAttribute::GetConnections</a>, will not translate them to the corresponding object in the instance's prototype prim. Consumers can use <a class="el" href="_usd__page__scenegraph_instancing.html#Usd_ScenegraphInstancing_InstanceProxies">instance proxies</a> to interact with these paths and retrieve the corresponding object in the prototype prim if needed. However, if these functions are called on a <a class="el" href="class_usd_relationship.html" title="A UsdRelationship creates dependencies between scenegraph objects by allowing a prim to target other ...">UsdRelationship</a> or <a class="el" href="class_usd_attribute.html" title="Scenegraph object for authoring and retrieving numeric, string, and array valued data,...">UsdAttribute</a> that belong to a prim in a prototype, paths that point to objects in instances of that prototype will be returned as paths in that prototype.</p>
<dl class="section note"><dt>Note</dt><dd>The following example demonstrates behavior with relationship targets, but the same behavior holds for attribute connections.</dd></dl>
<center> <a class="anchor" id=""></a>
<table border="0">
<caption>Example Scene Description and Scenegraph with Relationships</caption>
<tr>
<td valign="top"><div class="fragment"><div class="line"><span class="preprocessor">### ParkingLot.usd</span></div><div class="line"></div><div class="line"><span class="preprocessor">#usda 1.0</span></div><div class="line"></div><div class="line">def <span class="stringliteral">&quot;ParkingLot&quot;</span></div><div class="line">{</div><div class="line">    def <span class="stringliteral">&quot;Car_1&quot;</span> (</div><div class="line">        instanceable = <span class="keyword">true</span></div><div class="line">        references = @./Car.usd@&lt;/Car&gt;</div><div class="line">    )</div><div class="line">    {</div><div class="line">    }</div><div class="line"></div><div class="line">    def <span class="stringliteral">&quot;Car_2&quot;</span> (</div><div class="line">        instanceable = <span class="keyword">true</span></div><div class="line">        references = @./Car.usd@&lt;/Car&gt;</div><div class="line">    )</div><div class="line">    {</div><div class="line">    }</div><div class="line"></div><div class="line">    def <span class="stringliteral">&quot;ShoppingCart&quot;</span></div><div class="line">    {</div><div class="line">        custom rel bodyRel = [</div><div class="line">            &lt;/ParkingLot/Car_1/Body&gt;,</div><div class="line">            &lt;/ParkingLot/Car_2/Body&gt;,</div><div class="line">        ]</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><div class="fragment"><div class="line"><span class="preprocessor">### Car.usd</span></div><div class="line"></div><div class="line"><span class="preprocessor">#usda 1.0</span></div><div class="line"></div><div class="line">def <span class="stringliteral">&quot;Car&quot;</span></div><div class="line">{</div><div class="line">    def Mesh <span class="stringliteral">&quot;Body&quot;</span></div><div class="line">    {</div><div class="line">        custom rel doorRel = &lt;/Car/Door&gt;</div><div class="line">    }</div><div class="line"></div><div class="line">    def Mesh <span class="stringliteral">&quot;Door&quot;</span></div><div class="line">    {</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment -->  </td><td valign="middle"><div class="image">
<img src="Relationship_Example.png" alt="Relationship_Example.png"/>
</div>
   </td></tr>
</table>
</center><div class="fragment"><div class="line">&gt;&gt;&gt; stage = Usd.Stage.Open(<span class="stringliteral">&#39;ParkingLot.usd&#39;</span>)</div><div class="line"></div><div class="line">&gt;&gt;&gt; cart = stage.GetPrimAtPath(<span class="stringliteral">&#39;/ParkingLot/ShoppingCart&#39;</span>)</div><div class="line">&gt;&gt;&gt; cart_bodyRel = cart.GetRelationship(<span class="stringliteral">&#39;bodyRel&#39;</span>)</div><div class="line"></div><div class="line"><span class="comment"># &#39;bodyRel&#39; is a relationship on a prim that is not being instanced. Its </span></div><div class="line"><span class="comment"># targets point to prims beneath Car_1 and Car_2, which are both instances </span></div><div class="line"><span class="comment"># in this scene.</span></div><div class="line">&gt;&gt;&gt; cart_bodyRel.GetTargets()</div><div class="line">[Sdf.Path(<span class="stringliteral">&#39;/ParkingLot/Car_1/Body&#39;</span>), Sdf.Path(<span class="stringliteral">&#39;/ParkingLot/Car_2/Body&#39;</span>)]</div><div class="line"></div><div class="line"><span class="comment"># Calling Usd.Stage.GetPrimAtPath with these targets will return instance</span></div><div class="line"><span class="comment"># proxies, so consumers can easily interact with these targets even though</span></div><div class="line"><span class="comment"># they are prims beneath instances.</span></div><div class="line">&gt;&gt;&gt; [stage.GetPrimAtPath(p) <span class="keywordflow">for</span> p <span class="keywordflow">in</span> cart_bodyRel.GetTargets()]</div><div class="line">[Usd.Prim(&lt;/ParkingLot/Car_1/Body&gt;), Usd.Prim(&lt;/ParkingLot/Car_2/Body&gt;)]</div><div class="line"></div><div class="line"><span class="comment"># &#39;doorRel&#39; is a relationship on a prim beneath an instance. If accessed</span></div><div class="line"><span class="comment"># through the instance&#39;s prototype, the target paths returned will be returned</span></div><div class="line"><span class="comment"># as paths in the instance&#39;s prototype.</span></div><div class="line">&gt;&gt;&gt; prototype = stage.GetPrimAtPath(<span class="stringliteral">&#39;/ParkingLot/Car_1&#39;</span>).GetPrototype()</div><div class="line">&gt;&gt;&gt; prototype_doorRel = prototype.GetChild(<span class="stringliteral">&#39;Body&#39;</span>).GetRelationship(<span class="stringliteral">&#39;doorRel&#39;</span>)</div><div class="line"></div><div class="line">&gt;&gt;&gt; prototype_doorRel.GetPath()</div><div class="line">Sdf.Path(<span class="stringliteral">&#39;/__Prototype_1/Body.doorRel&#39;</span>)</div><div class="line"></div><div class="line">&gt;&gt;&gt; prototype_doorRel.GetTargets()</div><div class="line">[Sdf.Path(<span class="stringliteral">&#39;/__Prototype_1/Door&#39;</span>)]</div><div class="line"></div><div class="line"><span class="comment"># If the relationship is accessed through instance proxies, the relationship</span></div><div class="line"><span class="comment"># target API behaves as though instancing is not present.</span></div><div class="line">&gt;&gt;&gt; instanceProxy = stage.GetPrimAtPath(<span class="stringliteral">&#39;/ParkingLot/Car_1/Body&#39;</span>)</div><div class="line">&gt;&gt;&gt; instanceProxy_doorRel = instanceProxy.GetRelationship(<span class="stringliteral">&#39;doorRel&#39;</span>)</div><div class="line"></div><div class="line">&gt;&gt;&gt; instanceProxy_doorRel.GetPath()</div><div class="line">Sdf.Path(<span class="stringliteral">&#39;/ParkingLot/Car_1/Body.doorRel&#39;</span>)</div><div class="line"></div><div class="line">&gt;&gt;&gt; instanceProxy_doorRel.GetTargets()</div><div class="line">[Sdf.Path(<span class="stringliteral">&#39;/ParkingLot/Car_1/Door&#39;</span>)]</div><div class="line"></div><div class="line">&gt;&gt;&gt; instanceProxy_2 = stage.GetPrimAtPath(<span class="stringliteral">&#39;/ParkingLot/Car_2/Body&#39;</span>)</div><div class="line">&gt;&gt;&gt; instanceProxy_2_doorRel = instanceProxy_2.GetRelationship(<span class="stringliteral">&#39;doorRel&#39;</span>)</div><div class="line"></div><div class="line">&gt;&gt;&gt; instanceProxy_2_doorRel.GetPath()</div><div class="line">Sdf.Path(<span class="stringliteral">&#39;/ParkingLot/Car_2/Body.doorRel&#39;</span>)</div><div class="line"></div><div class="line">&gt;&gt;&gt; instanceProxy_2_doorRel.GetTargets()</div><div class="line">[Sdf.Path(<span class="stringliteral">&#39;/ParkingLot/Car_2/Door&#39;</span>)]</div></div><!-- fragment --><h1><a class="anchor" id="Usd_ScenegraphInstancing_Issues"></a>
Common Issues</h1>
<h2><a class="anchor" id="Usd_ScenegraphInstancing_IssuesSinglePrim"></a>
Instancing Single Prims</h2>
<p>Since instancing shares the scenegraph hierarchy beneath instance prims, instancing a single prim that has no descendants provides no benefits. In the case that instancing a single prim is desired (e.g., instancing a mesh), that prim should be made a descendant of another prim that is referenced into the scene, as shown below:</p>
<div class="fragment"><div class="line"><span class="preprocessor">### Model.usd</span></div><div class="line"></div><div class="line"><span class="preprocessor">#usda 1.0</span></div><div class="line"></div><div class="line">over <span class="stringliteral">&quot;InstancedMeshSource&quot;</span></div><div class="line">{</div><div class="line">    def Mesh <span class="stringliteral">&quot;Mesh&quot;</span></div><div class="line">    {</div><div class="line"><span class="preprocessor">        # ...</span></div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line">def <span class="stringliteral">&quot;Model&quot;</span></div><div class="line">{</div><div class="line">    def <span class="stringliteral">&quot;Mesh_1&quot;</span> (</div><div class="line">        instanceable = <span class="keyword">true</span></div><div class="line">        references = &lt;/InstancedMesh&gt;</div><div class="line">    )</div><div class="line">    {</div><div class="line">    }</div><div class="line"></div><div class="line">    def <span class="stringliteral">&quot;Mesh_2&quot;</span> (</div><div class="line">        instanceable = <span class="keyword">true</span></div><div class="line">        references = &lt;/InstancedMesh&gt;</div><div class="line">    )</div><div class="line">    {</div><div class="line">    }</div><div class="line"></div><div class="line"><span class="preprocessor">    # ...</span></div><div class="line"><span class="preprocessor">}</span></div></div><!-- fragment --><h1><a class="anchor" id="Usd_ScenegraphInstancing_Advanced"></a>
Advanced Topics</h1>
<h2><a class="anchor" id="Usd_ScenegraphInstancing_PrototypeSelection"></a>
How USD Generates Prototype Prims</h2>
<p>To determine the set of prototype prims needed, <a class="el" href="class_usd_stage.html" title="The outermost container for scene description, which owns and presents composed prims as a scenegraph...">UsdStage</a> analyzes each prim marked as instanceable and computes an "instancing key" that consists of:</p>
<ul>
<li>The direct composition arcs on the prim that pull in scene description, in order from strongest to weakest</li>
<li>The variant selections applied to the prim</li>
<li>The <a class="el" href="_usd__page__value_clips.html">value clips</a> that affect the prim</li>
<li>The <a class="el" href="class_usd_stage_load_rules.html" title="This class represents rules that govern payload inclusion on UsdStages.">UsdStageLoadRules</a> from the stage that apply to the prim and its descendants</li>
<li>The <a class="el" href="class_usd_stage_population_mask.html" title="This class represents a mask that may be applied to a UsdStage to limit the set of UsdPrim s it popul...">UsdStagePopulationMask</a> from the stage that applies to the prim and its descendants</li>
</ul>
<p>These elements, along with the <a class="el" href="_usd__page__scenegraph_instancing.html#Usd_ScenegraphInstancing_Editing">restriction on per-instance overrides</a> of descendant prims and their properties, guarantee that every prim with the same key will have the same scenegraph hierarchy beneath them, and that computing any values or metadata will return the same result.</p>
<p><a class="el" href="class_usd_stage.html" title="The outermost container for scene description, which owns and presents composed prims as a scenegraph...">UsdStage</a> groups the instanceable prims by their key and generates a prototype prim for each group. During this process, <a class="el" href="class_usd_stage.html" title="The outermost container for scene description, which owns and presents composed prims as a scenegraph...">UsdStage</a> will select one instanceable prim per group to serve as the source for the corresponding prototype prim.</p>
<p>This selection is non-deterministic; this allows for multi-threaded discovery of instances with minimal locking, and since all of the prims in a group have the same scenegraph hierarchy and values, it doesn't matter which is selected. Enabling <code>USD_INSTANCING</code> <a class="el" href="group__group__tf___debugging_output.html#ga6db9ff23ef8a070034390745b54e1bf6" title="Evaluate and print debugging message msg if enumVal is enabled for debugging.">TF_DEBUG</a> flag will given some diagnostic information about this process.</p>
<p><a class="el" href="class_usd_stage.html" title="The outermost container for scene description, which owns and presents composed prims as a scenegraph...">UsdStage</a> will update prototypes as instanceable prims are added or removed, or whenever an element that is part of the instancing key changes. For example, if an instance prim's variant selection is changed, <a class="el" href="class_usd_stage.html" title="The outermost container for scene description, which owns and presents composed prims as a scenegraph...">UsdStage</a> will recompute its key and either assign that instance to an already-existing prototype if there are existing instances with the same key, or create a new prototype.</p>
<h2><a class="anchor" id="Usd_ScenegraphInstancing_NestedInstancing"></a>
Nested Instancing</h2>
<p>An instanceable prim may have children that are themselves instanceable. This "nested instancing" allows consumers to build up large aggregate assets from smaller ones and use instancing to share as much of the scenegraph as possible, even between the smaller pieces. For example, after constructing a parking lot asset with many instances of a car model, an asset representing a large superstore could be created that brings in multiple instances of that parking lot.</p>
<center> <a class="anchor" id=""></a>
<table border="0">
<caption>Example Scene Description and Scenegraph with Nested Instancing</caption>
<tr>
<td valign="top"><div class="fragment"><div class="line"><span class="preprocessor">### BuyNLarge.usd</span></div><div class="line"></div><div class="line"><span class="preprocessor">#usda 1.0</span></div><div class="line"></div><div class="line">def <span class="stringliteral">&quot;BuyNLarge&quot;</span></div><div class="line">{</div><div class="line">    def <span class="stringliteral">&quot;ParkingLot_1&quot;</span> (</div><div class="line">        instanceable = <span class="keyword">true</span></div><div class="line">        references = @./ParkingLot.usd@&lt;/ParkingLot&gt;</div><div class="line">    )</div><div class="line">    {</div><div class="line">    }</div><div class="line"></div><div class="line">    def <span class="stringliteral">&quot;ParkingLot_2&quot;</span> (</div><div class="line">        instanceable = <span class="keyword">true</span></div><div class="line">        references = @./ParkingLot.usd@&lt;/ParkingLot&gt;</div><div class="line">    )</div><div class="line">    {</div><div class="line">    }</div><div class="line"></div><div class="line"><span class="preprocessor">    # ...</span></div><div class="line"></div><div class="line">    def <span class="stringliteral">&quot;ParkingLot_n&quot;</span> (</div><div class="line">        instanceable = <span class="keyword">true</span></div><div class="line">        references = @./ParkingLot.usd@&lt;/ParkingLot&gt;</div><div class="line">    )</div><div class="line">    {</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><div class="fragment"><div class="line"><span class="preprocessor">### ParkingLot.usd</span></div><div class="line"></div><div class="line"><span class="preprocessor">#usda 1.0</span></div><div class="line"></div><div class="line">def <span class="stringliteral">&quot;ParkingLot&quot;</span></div><div class="line">{</div><div class="line">    def <span class="stringliteral">&quot;Car_1&quot;</span> (</div><div class="line">        instanceable = <span class="keyword">true</span></div><div class="line">        references = @./Car.usd@&lt;/Car&gt;</div><div class="line">    )</div><div class="line">    {</div><div class="line">    }</div><div class="line"></div><div class="line">    def <span class="stringliteral">&quot;Car_2&quot;</span> (</div><div class="line">        instanceable = <span class="keyword">true</span></div><div class="line">        references = @./Car.usd@&lt;/Car&gt;</div><div class="line">    )</div><div class="line">    {</div><div class="line">    }</div><div class="line"></div><div class="line"><span class="preprocessor">    # ...</span></div><div class="line"></div><div class="line">    def <span class="stringliteral">&quot;Car_n&quot;</span> (</div><div class="line">        instanceable = <span class="keyword">true</span></div><div class="line">        references = @./Car.usd@&lt;/Car&gt;</div><div class="line">    )</div><div class="line">    {</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment -->  </td><td valign="middle"><div class="image">
<img src="Nested_Instancing_Example.png" alt="Nested_Instancing_Example.png"/>
</div>
   </td></tr>
</table>
</center><p>In the above example, USD will generate two prototype prims to accommodate the instanced ParkingLot and Car prims. Even though the Car prims are spread out among the different ParkingLot prims, USD will recognize that they can all share a single prototype prim, since they all have the same composition structure and can share the same scenegraph.</p>
<p>When <a class="el" href="_usd__page__scenegraph_instancing.html#Usd_ScenegraphInstancing_Prototypes">traversing the scenegraph using prototypes</a>, it is important to note that, in the nested case, prims in prototypes may also be instances and requiring accessing the associated prototypes to continue traversal. In this example, the prototype prim for the ParkingLot prims, /__Prototype_2, contains instance Car prims that are associated with their prototype prim, /__Prototype_1.</p>
<p>When <a class="el" href="_usd__page__scenegraph_instancing.html#Usd_ScenegraphInstancing_InstanceProxies">working with instance proxies</a>, nested instancing will be taken into account and resolved as if instancing were not being used on the stage.</p>
<h2><a class="anchor" id="Usd_ScenegraphInstancing_Flattening"></a>
Flattening</h2>
<p>When flattening a <a class="el" href="class_usd_stage.html" title="The outermost container for scene description, which owns and presents composed prims as a scenegraph...">UsdStage</a> into a single layer via its various <a class="el" href="class_usd_stage.html#Usd_stageSerialization">serialization methods</a>, each prototype prim in the scenegraph will be written out to specially-named root prim. These prims will be referenced by the flattened instance prims that were associated with that prototype. </p>
</div></div><!-- PageDoc -->
</div><!-- contents -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.9.6-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="usd_page_front.html">Usd : Universal Scene Description (Core)</a></li><li class="navelem"><a class="el" href="_usd__page__advanced_features.html">Advanced Scenegraph Scalability Features</a></li>
    <li class="footer">&copy; Copyright 2023, Pixar Animation Studios. Generated on Mon Nov 20 2023 16:06:57 by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.8.15 </li>
  </ul>
</div>
</body>
</html>